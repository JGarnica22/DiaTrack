---
title: "Diabetes data analysis"
author: "Josep Garnica Caparrós"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: true
subtitle: "Analysis of combined continuous glucose monitoring and insulin pump delivery data for type 1 diabetes treatment"
---

```{r setup, include=F, message=F}
knitr::opts_knit$set(root.dir = 'C:/Users/Garnica/OneDrive - Universitat de Barcelona/Documentos/UOC/TFM/DiaTrack/')
knitr::opts_chunk$set(echo = F, warning = F,include=T, message=F,
                      results="markup",
                      fig.path = "../figs/" ,
                      dev="svg")
```

# Define parameters to use for analysis
## Diabetes manegement parameters

```{r}
#Set low and high threesholds:
low <- 70
high <- 180
glucose_source <- "xdrip"
insulin_source <- "MiniMed"
#dates interval to show
from <- "2022-07-16"
to <- "2023-01-29"

## setting timez of the day
morning <- c(7,12)
midday <- c(13,15)
afternoon <- c(16,19)
evening <- c(20,23)
nigth <- c(0,6)
```


## Load and process CGM data
```{r load data}
source("scripts/CGM_process.R")
glu_path <- "data/CGM_xDrip_export_20230126-165100.csv"

glucose <- CGM_process(glupath)
```

## Load and process Insulin pump data
Also compute insulin plasma insulin
```{r}
source("scripts/Insulin_pump_process.R")
ins_path <- "data/Insulin_pump_MiniMed_8-3-2023.csv"

# Arrange insulin events and data and compute insulin in plasma
tins <- Insulin_process(ins_path)
```


### Merge
```{r}
fi <- left_join(tins, glucose, by="time") %>%
  # remove not need rows
  filter(!is.na(glucose) |
         !is.na(Bolus_type) |
         !is.na(Action))
```


# Classify events
Create a new dataframe with the events in this period of time
```{r}
source("scripts/Event_classification.R")
events <- Event_classification(fi)
```

# Analysis
```{r}
source("scripts/Categories_time.R")
# Function to obtain ranges of glucose data, risk, and
# time of the day and time of the week of time points
fi <- Categories_time(fi)

```

## Diabetes measuraments
### glucose and insulin data summarize
```{r}
source("scripts/Summary_diabetes_measurements.R")
source("scripts/Utils.R")
Diabetes_summary <- Summary_diabetes_measures(glucose, fi, events)
```


```{r}
saveRDS(fi, paste0("out/Integration", Sys.Date() ,".rds"))
saveRDS(events, paste0("out/Events_", Sys.Date() ,".rds"))
writexl::write_xlsx(Diabetes_summary, paste0("out/stats_measurement_", Sys.Date(), ".xlsx"))
```

# Stats
## Chi-squared test for weekday and time day distribution of undesired events
```{r}
e2 <- events %>% 
  select(grep("type|AUC|ActI|extreme|N_bolus|timeday|weekday|start|end", names(.),value = T)) %>% 
  filter(Event_subtype != "Normoglycemia")

cq.hyper <- e2 %>% filter(Event_subtype == "Hyperglycemia") %>%  
              with(table(weekday))
cq.hyper
chisq.test(cq.hyper)
cq.hypo <- e2 %>% filter(Event_subtype == "Hypoglycemia") %>%  
              with(table(weekday))
cq.hypo
chisq.test(cq.hypo)

cq2.hyper <- e2 %>% filter(Event_subtype == "Hyperglycemia") %>%  
              with(table(timeday))
cq2.hyper
chisq.test(cq2.hyper)
cq2.hypo <- e2 %>% filter(Event_subtype == "Hypoglycemia") %>%  
              with(table(timeday))
cq2.hypo
chisq.test(cq2.hypo)

```
## regression
```{r}
e3 <- events %>% 
  filter(Event_subtype != "Normoglycemia") %>% 
  filter(complete.cases(.)) %>% 
  mutate(extrem.risk = 10*(1.509 * (log(extreme.value)^1.084 - 5.381)),
         slope.risk = 10*(1.509 * (log(Total_slope)^1.084 - 5.381)))
e3[is.infinite(e3$Diff_bolus),"Diff_bolus"] <- (time.bf+time.af)/60

# scaling and normalization
# select numerical variables for the model
num <- c("Total_slope", "Diff_bolus", "Bolus_ActI",
         "Basal_ActI", "Total_ActI", "N_bolus", "extrem.risk", "extreme.value")
X <- e3[,num] %>% scale(.)
# We calculate norma L2 using apply
L2 <- apply(X, 2, function(x) {sqrt(sum(x^2))})
# we divied each value for its respective norma L2
X <- X/L2
```

```{r}
cat <- c("Event_type", "Event_subtype", "weekday", "timeday")
lm.data <- cbind(e3[, cat], as.data.frame(X))
lm.data <- lm.data %>% 
  mutate(Event_subtype = factor(Event_subtype,
                             levels=c("Hypoglycemia", "Hyperglycemia"),
                             labels=c(0,1), ordered = T)
         )
```

### logistic regression
```{r}
lgm <- glm(Event_subtype ~ Total_slope + Diff_bolus + Bolus_ActI + 
            Basal_ActI + N_bolus + weekday + timeday,
            data= lm.data,
            family = binomial)
summary(lgm)
exp(coef(lgm))
```



# Plots
## Gluplot on hours
```{r plot_1}
  # Definie colors for rangers of glucose
  colrange <- c("Very low" = "black",
            "Low" = "red",
            "In range" = "green",
            "High" = "yellow3",
            "Very high" = "orange")
  colrisk <- c("Hypoglycemia risk" = "red",
            "Hyperglycemia risk" = "yellow3")
  # Define colors and transparency for source of insulin
  colins <- c("Bolus" = "cornflowerblue",
              "Basal" = "deeppink",
              "Total" = "dimgray")
  alins <- c("Bolus" = 0.9,
              "Basal" = 0.2,
              "Total" = 0.3)
  colins2 <- c("Bolus" = "cornflowerblue",
              "Basal rate" = "deeppink")
  alins2 <- c("Bolus" = 1,
              "Basal rate" = 0.45)
  
the <- theme(legend.position = "bottom")
# declare an event as `e`
gluplot <- function(e){
  # extract info from minute-wise dataframe
  df <- fi2[fi2$time >= e$start & fi2$time <= e$end,] %>% 
    mutate(risk.range = ifelse(risk > 0,
                               "Hyperglycemia risk",
                               "Hypoglycemia risk"))
 
  

  pointplot <- df %>% filter(!is.na(glucose)) %>% 
    ggplot(aes(x=time ,y=glucose)) + 
    geom_point(size=1, aes(color = Range), show.legend= T, alpha=0.65) +
    scale_color_manual(values= colrange,  name = "Glucose Range") +
    guides(color = guide_legend(override.aes = list(size = 4)))+
    labs(title = paste0("Glucose reading on ",
                        min(format(df$time, "%Y-%m-%d" )),
                        "\n", e$Event_type, " - ", e$Event_subtype)) +
    geom_hline(yintercept = c(low,high), linetype = "dashed")+
    theme(plot.title = element_text(size=18,hjust = 0.5))+ 
    ylab("glucose (mg/dL)") + theme_bw() + xlab("Time")+
    scale_x_datetime(date_labels = "%H:%M",
                     date_breaks = "30 mins",
                     expand = c(0.01,0.01))+
    scale_y_continuous(breaks = c(55,70,100,140,180, 240,300)) +
    the
  
  riskplot <- df %>% filter(!is.na(risk)) %>% 
    ggplot(aes(x=time ,y=risk)) + 
    geom_col(size=1, aes(fill = risk.range), show.legend= T, alpha=0.65) +
    scale_fill_manual(values= colrisk,  name = "Glucose Risk") +
    guides(color = guide_legend(override.aes = list(size = 4)))+
    ylab("glycemic risk") + theme_bw() + xlab("Time")+
    scale_x_datetime(date_labels = "%H:%M",
                     date_breaks = "30 mins",
                     expand = c(0.01,0.01)) +
    the
  
  acti <- df %>% select(time, Bolus_ActI, Basal_ActI, Total_ActI) %>% 
    pivot_longer(-time, names_to = "Insulin_source",
                 values_to = "Active insulin") %>% 
    mutate(Insulin_source = factor(Insulin_source,
                                   levels=c("Bolus_ActI", "Basal_ActI", "Total_ActI"),
                                   labels=c("Bolus", "Basal", "Total"))) %>% 
    ggplot(aes(time, `Active insulin`,
               fill=Insulin_source))+
    geom_area(aes(alpha=Insulin_source), position="identity")+
    scale_fill_manual(values = colins, name = "Insulin source")+
    scale_alpha_manual(values= alins, guide="none")+
    ylab("Insulin in plasma (U)") + theme_bw() + xlab("Time")+
    scale_x_datetime(date_labels = "%H:%M",
                     date_breaks = "30 mins",
                     expand = c(0.01,0.01))+
    labs(title = "Insulin in plasma")+
    the
  
  evs <- df %>% select(time, Bolus_type, Injec_bolus, Action, Basal_rate) %>% 
    pivot_longer(-c(time, Bolus_type, Action), names_to = "Insulin_source",
                 values_to = "Insulin") %>% 
    mutate(Insulin_source = factor(Insulin_source,
                                   levels=c("Injec_bolus", "Basal_rate"),
                                   labels=c("Bolus", "Basal rate"))) %>%
    ggplot(aes(time, Insulin, fill=Insulin_source))+
    geom_col(aes(alpha= Insulin_source), stat="identity",position = "identity")+
    geom_text(aes(y = max(Insulin)/2, label=Action),
               angle=90, size=4, color="blue")+
    geom_text(aes(y = max(Insulin)/2, label=Bolus_type),
               angle=90, size=4)+
    scale_fill_manual(values = colins2, name = "Insulin source")+
    scale_alpha_manual(values= alins2, guide="none")+
    ylab("Insulin injected (U)") + theme_bw() + xlab("Time")+
    scale_x_datetime(date_labels = "%H:%M",
                     date_breaks = "30 mins",
                     expand = c(0.01,0.01))+
    labs(title = "Insulin injected")+
    the
  
  # merge all plots
  require(ggpubr)
  plotlist <- list(pointplot, riskplot, acti, evs)
  pl <- ggarrange(plotlist=plotlist, ncol=1,
                  heights = c(5,4,4,4))
  
  return(pl)
}

```

## histogram of BG rate of change (15 min)
```{r}
glucose %>% filter(!is.na(slope15) & abs(slope15)<10) %>% 
  ggplot(aes(slope15)) +
  geom_histogram()+
  stat_function(fun = dnorm,
                args = list(mean = mean(glucose$slope15, na.rm=T),
                            sd = sd(glucose$slope15, na.rm=T)))+
  scale_y_log10() +
  xlab("BG Rate of Change (mg/dL/min)")

```
## Poincaré plot
```{r}
pdf <- fi2 %>% select(glucose, weekday, timeday) %>% filter(complete.cases(.))
pdf <- data.frame(i = pdf$glucose[2:nrow(pdf)],
                  i.1 = pdf$glucose[1:(nrow(pdf)-1)],
                  timeday = pdf$timeday[-1],
                  weekday = pdf$weekday[-1])
pdf %>% 
  ggplot(aes(i.1,i))+
  geom_point()+
  stat_ellipse(level=0.99, color=2)

```


## Event-based clinical characteristics CVGA (24h periods)
```{r}
# dataframe for labels
coor <- data.frame(
  status = c("Upper C", "Upper D", "E-zone",
             "Upper B", "B-zone", "Lower D",
             "A-zone", "Lower B", "Lower C"),
  x = c(rep(c(100,80,60),3)),
  y = c(rep(350,3), rep(240,3), rep(145,3)),
  col = c("yellow3", "darkorange1", "red4",
          "darkgreen", "darkgreen", "darkorange1",
          "springgreen1", "darkgreen", "yellow3")
)

col <- coor %>% pull(col,name = status)

ebc.plot <- function(ebc, tit = NULL){
ebc.plot <- 
  ebc %>% 
    mutate(Max = ifelse(Max > 400, 400,
                         ifelse(Max < 110, 110, Max)),
           Min = ifelse(Min < 50, 50,
                         ifelse(Min > 110, 110, Min))
           ) %>% 
  ggplot(aes(Min, Max)) + 
    geom_point(size=2.5, alpha=0.6, color="royalblue4") +
    geom_label(data=coor, aes(label=status,
                              x= x, y= y, color=status)) +
    scale_color_manual(values=col) +
    geom_vline(xintercept = c(90,70))+
    geom_hline(yintercept = c(180,300))+
    theme_bw()+
    scale_y_continuous(limits = c(110, 400) ,
                       breaks = c(110,180,300,400),
                       expand = c(110,110)) +
    scale_x_continuous(limits = c(110,50),
                       breaks = c(50, 70, 90, 110),
                       expand = c(110,110),
                       trans = "reverse") +
    coord_cartesian(expand = F) +
    ggtitle(tit) +
    theme(plot.title = element_text(hjust = 0.5, size=18))
return(ebc.plot)

}
```

```{r}
fi2 %>% 
  mutate(day = format(time, "%D")) %>% 
  group_by(day) %>% 
  summarize(Max = max(glucose, na.rm = T),
            Min = min(glucose, na.rm=T)) %>% 
  ebc.plot(tit="24h")

for(i in unique(fi2$timeday)){
  fi2 %>% 
  mutate(day = format(time, "%D")) %>% 
  group_by(day, timeday) %>% 
  summarize(Max = max(glucose, na.rm = T),
            Min = min(glucose, na.rm=T)) %>% 
  filter(timeday == i) %>% 
  ebc.plot(tit=i) %>% print()
}

for(i in unique(fi2$weekday)){
  fi2 %>% 
  mutate(day = format(time, "%D")) %>% 
  group_by(day, weekday) %>% 
  summarize(Max = max(glucose, na.rm = T),
            Min = min(glucose, na.rm=T)) %>% 
  filter(weekday == i) %>% 
  ebc.plot(tit=i) %>% print()
}


for(i in unique(fi2$meal_factor[fi2$meal_factor != "meal"])){
  fi2 %>% 
  mutate(day = format(time, "%D")) %>% 
  group_by(day, meal_factor) %>% 
  summarize(Max = max(glucose, na.rm = T),
            Min = min(glucose, na.rm=T)) %>% 
  filter(meal_factor == i) %>% 
  ebc.plot(tit=i) %>% print()
}
```



try to find days/times of the day with risk of hypo/hyper


use risk rather than glucose for regression?? The advantages of risk plot include: (1) the variance carried by hypo- and hyperglycemic readings is equalized; (2) excursions into extreme hypo- and hyperglycemia get progressively increasing risk values; and (3) the variance within the safe euglycemic range is attenuated, which reduces noise during data analysis. In essence, Figure 3 links better glycemic control to a narrower pattern of risk fluctuations. Because the LBGI, HBGI, and the combined BGRI can theoretically range from 0 to 100, their values can be interpreted as percentages of maximum possible risk.

## Percentile plots
```{r}
the <- theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_text(size=18, face = "bold"),
        legend.text = element_text(size=17),
        plot.title = element_text(size=25, face="bold"),
        axis.title =element_text(size=18),
        axis.text = element_text(size=16))

perplot <- function(fi2, subtit=NULL, tx="20 mins"){
    allgluplot <- 
      fi2 %>% filter(!is.na(glucose)) %>% 
      mutate(hoursmin = as.POSIXct(format(time,"%H:%M"),format="%H:%M"),
             tenmin = as.POSIXct(format(round_date(time, tx),"%H:%M"),
                                 format="%H:%M")) %>% 
      ggplot(aes(x=hoursmin ,y=glucose)) +
      stat_summary(aes(tenmin, fill = "coral1"), fun.min = quan5,
                   fun.max = quan95, geom = "ribbon", alpha = 0.15)+
      stat_summary(aes(tenmin, fill = "chocolate4"), fun.min = quan25,
                   fun.max = quan75, geom = "ribbon", alpha = 0.5)+
      stat_summary(fun=median, aes(tenmin, linetype = "Median"),
                   geom="line", color = "coral4", size = 1.5)+
      scale_linetype_manual("", values=1)+
      scale_fill_manual(name = "", values= c("chocolate4","coral1"),
                        label = c("75% values", "95% values"))+
      guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Glucose sensor readings")) +
      geom_hline(yintercept = c(low,high), linetype = "dashed")+
      theme(plot.title = element_text(size=18,hjust = 0.5))+ 
      xlab("Time of the day")+
      ylab("glucose (mg/dL)") +
      scale_x_datetime(date_labels = "%H",date_breaks = "1 hour", expand = c(0.01,0.01))+
      scale_y_continuous(breaks = c(55,70,100,140,180, 240,300)) +
      the
    
    allriskplot <- 
      fi2 %>% 
      mutate(hoursmin = as.POSIXct(format(time,"%H:%M"),format="%H:%M"),
             tenmin = as.POSIXct(format(round_date(time, tx),"%H:%M"),
                                 format="%H:%M")) %>% 
      ggplot(aes(x=hoursmin ,y=risk)) +
      stat_summary(aes(tenmin, fill = "lightsalmon"), fun.min = quan5,
                   fun.max = quan95, geom = "ribbon", alpha = 0.3)+
      stat_summary(aes(tenmin, fill = "lightpink1"), fun.min = quan25,
                   fun.max = quan75, geom = "ribbon", alpha = 0.5)+
      stat_summary(fun=median, aes(tenmin, linetype = "Median"),
                   geom="line", colour = "lightpink4", size = 1.5)+
      scale_linetype_manual("", values=1)+
        scale_fill_manual(name = "", values= c("lightpink1","lightpink4"),
                        label = c("75% values", "95% values"))+
        guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Risk")) +
      geom_hline(yintercept = c(-2.5,5), linetype = "dashed")+
      xlab("Time of the day")+
      ylab("Risk") +
      scale_x_datetime(date_labels = "%H",date_breaks = "1 hour", expand = c(0.01,0.01))+
      the
    
    allinsplot <- 
      fi2 %>% 
      select(time, Bolus_ActI, Basal_ActI, Total_ActI) %>%
        pivot_longer(-time, names_to = "Insulin_source",
                     values_to = "Active insulin") %>% 
        mutate(`Insulin source` = factor(Insulin_source,
                                       levels=c("Bolus_ActI", "Basal_ActI", "Total_ActI"),
                                       labels=c("Bolus", "Basal", "Total")),
              hoursmin = as.POSIXct(format(time,"%H:%M"),format="%H:%M"),
             tenmin = as.POSIXct(format(round_date(time, tx),"%H:%M"),
                                 format="%H:%M")) %>%
      ggplot(aes(x=hoursmin, y=`Active insulin`)) +
      stat_summary(aes(tenmin, fill = `Insulin source`), fun.min = quan25,
                   fun.max = quan75, geom = "ribbon", alpha = 0.6)+
      stat_summary(fun=median, aes(tenmin, linetype = "Median",
                                   color=`Insulin source`),
                   geom="line", size = 1.5)+
      scale_linetype_manual("", values=1)+
      scale_fill_identity(name = "", label = "75% values", guide="legend") +
      scale_fill_manual(values= colins)+
      scale_color_manual(values=colins) +
      guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Insulin in plasma"))+ 
      xlab("Time of the day")+
      ylab("Insulin in plasma (U)") +
      scale_x_datetime(date_labels = "%H",date_breaks = "1 hour", expand = c(0.01,0.01))+
      the 
    
    alleveplot <- 
      fi2 %>% 
      select(time, Bolus_type, Action) %>%
        pivot_longer(-time, names_to = "Event",
                     values_to = "Type") %>% 
        filter(Type %in% c("Normal", "Temporal_basal_start")) %>% 
        mutate(hoursmin = as.POSIXct(format(time,"%H:%M"),format="%H:%M"),
             tenmin = as.POSIXct(format(round_date(time, tx),"%H:%M"),
                                 format="%H:%M"),
             Type = factor(Type,
                           labels=c("Bolus", "Temporal basal (start)"))) %>%
      ggplot(aes(x=hoursmin)) +
      geom_bar(aes(fill=Type)) +
        guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Events"))+ 
      xlab("Time of the day")+
      ylab("Number of events") +
      scale_x_datetime(date_labels = "%H",date_breaks = "1 hour", expand = c(0.01,0.01))+
      the
    
    # merge all plots
      require(ggpubr)
      plotlist <- list(allgluplot, allriskplot,
                       allinsplot, alleveplot)
      pl <- ggarrange(plotlist=plotlist, ncol=1,
                      heights = c(4.5,4,4,4)) 
      pl <- annotate_figure(pl,
                      top = text_grob(paste0("Data from ",
                                             min(format(fi2$time, "%Y-%m-%d" )),
                                             " to ",
                          max(format(fi2$time, "%Y-%m-%d")), ": ",
                          round(as.numeric(to - from)), " days.       ",
                          subtit), 
               color = "black", face = "bold", size = 32))
    
    return(pl)
}

```

```{r}
svg("figs/perplot.svg", height = 24, width=15)
perplot(fi2)
dev.off()

for(i in levels(fi2$weekday)){
  x <- fi2 %>% filter(weekday == i)
  svg(paste0("figs/perplot_",i,".svg"), height = 24, width=15)
    print(perplot(x, subtit=i))
  dev.off()
}

for(i in levels(fi2$timeday)){
  x <- fi2 %>% filter(timeday == i) %>% 
    mutate(hm = as.numeric(format(time, "%H%M"))) %>% 
    filter(hm < 2350)
  svg(paste0("figs/perplot_",i,".svg"), height = 24, width=15)
    print(perplot(x, subtit=i, tx="5 mins"))
  dev.off()
}


svg("figs/perplot_outmeal.svg", height = 24, width=15)
x <- fi2 %>% filter(meal_factor == "outmeal")
perplot(x, subtit="Outmeal")
dev.off()


## hyperglycemia
for(o in c("Hyperglycemia","Hypoglycemia")){
  x <- data.frame(matrix(nrow=0, ncol=length(fi2)))
  names(x) <- names(fi2)
  idx <- which(events$Event_subtype == o)
  for(i in idx){
    x0 <- fi2 %>% filter(time >= events[i,"start"] & time <= events[i,"end"])
    x <- rbind(x, x0)
  }
  svg(paste0("figs/perplot_", o,".svg"), height = 24, width=15)
    print(perplot(x, subtit=o))
  dev.off()
}
```

### meal percentile plots

```{r}
the <- theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_text(size=18, face = "bold"),
        legend.text = element_text(size=17),
        plot.title = element_text(size=25, face="bold"),
        axis.title =element_text(size=18),
        axis.text = element_text(size=16))

mealplot <- function(fi2, subtit=NULL, tx=10){
    allgluplot <- 
      fi2 %>% filter(!is.na(glucose)) %>% 
      filter(meal_factor != "outmeal") %>% 
      mutate(tenmin = plyr::round_any(mealtime,tx)) %>% 
      ggplot(aes(x=mealtime ,y=glucose)) +
      stat_summary(aes(tenmin, fill = "coral1"), fun.min = quan5,
                   fun.max = quan95, geom = "ribbon", alpha = 0.15)+
      stat_summary(aes(tenmin, fill = "chocolate4"), fun.min = quan25,
                   fun.max = quan75, geom = "ribbon", alpha = 0.5)+
      stat_summary(fun=median, aes(tenmin, linetype = "Median"),
                   geom="line", color = "coral4", size = 1.5)+
      scale_linetype_manual("", values=1)+
      scale_fill_manual(name = "", values= c("chocolate4","coral1"),
                        label = c("75% values", "95% values"))+
      guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Glucose sensor readings")) +
      geom_hline(yintercept = c(low,high), linetype = "dashed")+
      theme(plot.title = element_text(size=18,hjust = 0.5))+ 
      xlab("Time around meal (min)")+
      ylab("glucose (mg/dL)") +
      scale_y_continuous(breaks = c(55,70,100,140,180, 240,300)) +
      scale_x_continuous(expand = c(0.01,0.01))+
      geom_vline(xintercept = 0, linetype = "twodash", color="purple4")+
      the
    
    allriskplot <- 
      fi2 %>% 
      filter(meal_factor != "outmeal") %>% 
      mutate(tenmin = plyr::round_any(mealtime,tx)) %>% 
      ggplot(aes(x=mealtime ,y=risk)) +
      stat_summary(aes(tenmin, fill = "lightsalmon"), fun.min = quan5,
                   fun.max = quan95, geom = "ribbon", alpha = 0.3)+
      stat_summary(aes(tenmin, fill = "lightpink1"), fun.min = quan25,
                   fun.max = quan75, geom = "ribbon", alpha = 0.5)+
      stat_summary(fun=median, aes(tenmin, linetype = "Median"),
                   geom="line", colour = "lightpink4", size = 1.5)+
      scale_linetype_manual("", values=1)+
        scale_fill_manual(name = "", values= c("lightpink1","lightpink4"),
                        label = c("75% values", "95% values"))+
        guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Risk")) +
      geom_hline(yintercept = c(-2.5,5), linetype = "dashed")+
      scale_x_continuous(expand = c(0.01,0.01))+
      geom_vline(xintercept = 0, linetype = "twodash", color="purple4")+ 
      xlab("Time around meal (min)")+
      ylab("Risk") +
      the
    
    allinsplot <- 
      fi2 %>% 
        filter(meal_factor != "outmeal") %>%
        select(mealtime, Bolus_ActI, Basal_ActI, Total_ActI) %>%
          pivot_longer(-mealtime, names_to = "Insulin_source",
                       values_to = "Active insulin") %>% 
        mutate(tenmin = plyr::round_any(mealtime,tx),
               `Insulin source` = factor(Insulin_source,
                                 levels=c("Bolus_ActI", "Basal_ActI", "Total_ActI"),
                                 labels=c("Bolus", "Basal", "Total"))) %>%
      ggplot(aes(x=mealtime, y=`Active insulin`)) +
      stat_summary(aes(tenmin, fill = `Insulin source`), fun.min = quan25,
                   fun.max = quan75, geom = "ribbon", alpha = 0.6)+
      stat_summary(fun=median, aes(tenmin, linetype = "Median",
                                   color=`Insulin source`),
                   geom="line", size = 1.5)+
      scale_linetype_manual("", values=1)+
      scale_fill_identity(name = "", label = "75% values", guide="legend") +
      scale_fill_manual(values= colins)+
      scale_color_manual(values=colins) +
      guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Insulin in plasma"))+
      scale_x_continuous(expand = c(0.01,0.01))+
      geom_vline(xintercept = 0, linetype = "twodash", color="purple4")+
      xlab("Time around meal (min)")+
      ylab("Insulin in plasma (U)") +
      the 
    
    alleveplot <- 
      fi2 %>% 
        filter(meal_factor != "outmeal") %>%
      select(mealtime, Bolus_type, Action) %>%
        pivot_longer(-mealtime, names_to = "Event",
                     values_to = "Type") %>% 
        filter(Type %in% c("Normal", "Temporal_basal_start")) %>% 
        mutate(tenmin = plyr::round_any(mealtime,tx),
             Type = factor(Type,
                           labels=c("Bolus", "Temporal basal (start)"))) %>%
      ggplot(aes(x=mealtime)) +
      geom_bar(aes(fill=Type)) +
        guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Events"))+ 
      xlab("Time around meal (min)")+
      ylab("Number of events") +
      scale_x_continuous(expand = c(0.01,0.01))+
      geom_vline(xintercept = 0, linetype = "twodash", color="purple4")+
      the
    
    # merge all plots
      require(ggpubr)
      plotlist <- list(allgluplot, allriskplot,
                       allinsplot, alleveplot)
      pl <- ggarrange(plotlist=plotlist, ncol=1,
                      heights = c(4.5,4,4,4)) 
      pl <- annotate_figure(pl,
                      top = text_grob(paste0("Data from ",
                                             min(format(fi2$time, "%Y-%m-%d" )),
                                             " to ",
                          max(format(fi2$time, "%Y-%m-%d")), ": ",
                          round(as.numeric(to - from)), " days.       ",
                          subtit), 
               color = "black", face = "bold", size = 32))
    
    return(pl)
}

```


```{r}
svg("figs/perplot_meals.svg", height = 24, width=15)
mealplot(fi2)
dev.off()

```

## TIR plots
```{r}
svg("figs/all_tir.svg", height = 2, width = 7)
fi2 %>% 
  with(table(Range)) %>% prop.table() %>% 
  as.data.frame() %>%
  mutate(Freq = round(100*Freq),
         Freqann = paste0(Freq, "%")) %>% 
  ggplot(aes(y=Freq, x="",
             fill=Range, label=Freqann)) +
  geom_bar(stat="identity") +
  scale_fill_manual("", values=colrange)+
  ggrepel::geom_label_repel(aes(color=Range,fontface=2),
                            size = 4, face="bold", fill="grey65",
             position = position_stack(vjust = 0.5),
             show.legend = F)+
  scale_color_manual("", values=colrange)+
  theme_void() +
  coord_flip() +
  theme(legend.position = "bottom")
dev.off()

svg("figs/TIR_weekday.svg", height = 3, width = 10)
fi2 %>% 
  filter(!is.na(Range)) %>% 
  group_by(weekday, Range) %>% 
  summarize(Freq0 = n()) %>% as.data.frame() %>% 
  group_by(weekday) %>% 
  summarize(Freq = Freq0/sum(Freq0), Range= Range) %>% 
  mutate(Freq = round(100*Freq),
         Freqann = paste0(Freq, "%")) %>% 
  ggplot(aes(y=Freq, x="",
             fill=Range, label=Freqann)) +
  geom_bar(stat="identity") +
  scale_fill_manual("", values=colrange)+
  ggrepel::geom_label_repel(aes(color=Range, fontface=2),
                            size = 4, face="bold", fill="grey65",
             position = position_stack(vjust = 0.5),
             show.legend = F)+
  scale_color_manual("", values=colrange)+
  theme_void() +
  coord_flip() +
  theme(legend.position = "bottom")+
  facet_wrap(~weekday, ncol=4)
dev.off()

svg("figs/TIR_timeday.svg", height = 4, width = 9)
fi2 %>% 
  filter(!is.na(Range)) %>% 
  group_by(timeday, Range) %>% 
  summarize(Freq0 = n()) %>% as.data.frame() %>% 
  group_by(timeday) %>% 
  summarize(Freq = Freq0/sum(Freq0), Range= Range) %>% 
  mutate(Freq = round(100*Freq),
         Freqann = paste0(Freq, "%")) %>% 
  ggplot(aes(y=Freq, x="",
             fill=Range, label=Freqann)) +
  geom_bar(stat="identity") +
  scale_fill_manual("", values=colrange)+
  ggrepel::geom_label_repel(aes(color=Range, fontface=2),
                            size = 4, face="bold", fill="grey65",
             position = position_stack(vjust = 0.5),
             show.legend = F)+
  scale_color_manual("", values=colrange)+
  theme_void() +
  coord_flip() +
  theme(legend.position = "bottom")+
  facet_wrap(~timeday, ncol=3)
dev.off()

```

## boxplot
```{r}
gluweekbox <- 
  fi2 %>% 
  ggplot(aes(x = weekday, y = glucose)) +
  geom_jitter(aes(color=Range),alpha = 0.35, size = 0.5)+
  scale_color_manual(values= colrange)+
  guides(color = guide_legend(override.aes = list(size = 6)))+
  geom_boxplot(colour = "violetred4", fill = "snow3",
               size = 0.6, notch=F) +
  ylab("glucose (mg/dL)")+
  geom_hline(yintercept = c(low,high), linetype = "dashed")+
  theme_bw()

riskweekbox <- 
  fi2 %>% 
  ggplot(aes(x = weekday, y = risk)) +
  geom_jitter(aes(color=Range),alpha = 0.35, size = 0.5)+
  scale_color_manual(values= colrange)+
  guides(color = guide_legend(override.aes = list(size = 6)))+
  geom_boxplot(colour = "violetred4", fill = "snow3",
               size = 0.6, notch=F) +
  ylab("Risk")+
  geom_hline(yintercept = c(-2.5,5), linetype = "dashed")+
  theme_bw()

glutdbox <- 
  fi2 %>% 
  ggplot(aes(x = timeday, y = glucose)) +
  geom_jitter(aes(color=Range),alpha = 0.35, size = 0.5)+
  scale_color_manual(values= colrange)+
  guides(color = guide_legend(override.aes = list(size = 6)))+
  geom_boxplot(colour = "violetred4", fill = "snow3",
               size = 0.6, notch=F) +
  ylab("glucose (mg/dL)")+
  geom_hline(yintercept = c(low,high), linetype = "dashed")+
  theme_bw()

risktdbox <- 
  fi2 %>% 
  ggplot(aes(x = timeday, y = risk)) +
  geom_jitter(aes(color=Range),alpha = 0.35, size = 0.5)+
  scale_color_manual(values= colrange)+
  guides(color = guide_legend(override.aes = list(size = 6)))+
  geom_boxplot(colour = "violetred4", fill = "snow3",
               size = 0.6, notch=F) +
  ylab("Risk")+
  geom_hline(yintercept = c(-2.5,5), linetype = "dashed")+
  theme_bw()

```

## events plots
```{r}
# weekdays
ndays <- fi2 %>%
  mutate(day = format(time, "%D")) %>% 
  distinct(day, weekday) %>% 
  group_by(weekday) %>% 
  summarize(ndays = n())

eventweek <- rbind(
  events %>% group_by(weekday, Event_subtype) %>% 
  summarize(Count = n()) %>% rename(Event = "Event_subtype"),
  events %>% group_by(weekday, Event_type) %>% 
  summarize(Count = n()) %>% rename(Event = "Event_type")
  ) %>% filter(!Event %in% c("Normoglycemia", "No_Meal")) %>% 
  left_join(ndays, ., by= "weekday") %>% 
  mutate(Counts = Count/ndays) %>% 
  ggplot(aes(weekday, Counts, fill=Event)) +
  geom_col(position = "dodge2")+
  ylab("Counts/day of the week")+
  theme_bw()

# time of the day
ntime <- fi2 %>%
  mutate(day = format(time, "%D")) %>% 
  distinct(day, timeday) %>% 
  group_by(timeday) %>% 
  summarize(ntime = n())
eventday <- rbind(
  events %>% group_by(timeday, Event_subtype) %>% 
  summarize(Count = n()) %>% rename(Event = "Event_subtype"),
  events %>% group_by(timeday, Event_type) %>% 
  summarize(Count = n()) %>% rename(Event = "Event_type")
  ) %>% filter(!Event %in% c("Normoglycemia", "No_Meal")) %>% 
  left_join(ntime, ., by= "timeday") %>% 
  mutate(Counts = Count/ntime) %>% 
  ggplot(aes(timeday, Counts, fill=Event)) +
  geom_col(position = "dodge2")+
  ylab("Counts/time of day")+
  theme_bw()

```






