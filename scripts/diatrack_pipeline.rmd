---
title: "Diabetes data analysis"
author: "Josep Garnica Caparrós"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: true
    keep_md: yes
subtitle: "Analysis of combined continuous glucose monitoring and insulin pump delivery data for type 1 diabetes treatment"
---

```{r setup, include=F, message=F}
knitr::opts_knit$set(root.dir = 'C:/Users/Garnica/OneDrive - Universitat de Barcelona/Documentos/UOC/TFM/DiaTrack/')
knitr::opts_chunk$set(echo = F, warning = F,include=T, message=F,
                      results="markup", cache=T, 
                      fig.path = "../figs/" ,
                      dev="svg")
```

# Define parameters to use for analysis
## Diabetes manegement parameters
We define the parameters we will use for our analysis. The threshold for hypoglycemia and hyperglycemia, the raw data source type, the time period we want to study and the how we categorize the times of the day.

```{r analysis_parameters}
#Set low and high threesholds:
low <- 70
high <- 180

# set the source of glucose data
glucose_source <- "xdrip"
# set the source of insulin pump data
insulin_source <- "MiniMed"

#dates interval to show
from <- "2022-07-16"
to <- "2023-01-29"

## setting times of the day
morning <- c(7,12)
midday <- c(13,15)
afternoon <- c(16,19)
evening <- c(20,23)
nigth <- c(0,6)
```


## Load and process CGM data
```{r load_CGM_data}
source("scripts/CGM_process.R")
glu_path <- "data/CGM_xDrip_export_20230126-165100.csv"

glucose <- CGM_process(glupath)


```

## Load and process Insulin pump data
Also compute insulin plasma insulin
```{r}
source("scripts/Insulin_pump_process.R")
ins_path <- "data/Insulin_pump_MiniMed_8-3-2023.csv"

# Arrange insulin events and data and compute insulin in plasma
tins <- Insulin_process(ins_path)
```


### Merge
```{r}
fi <- left_join(tins, glucose, by="time") %>%
  # remove not need rows
  filter(!is.na(glucose) |
         !is.na(Bolus_type) |
         !is.na(Action))
```


# Classify events
Create a new dataframe with the events in this period of time
```{r}
source("scripts/Event_classification.R")
events <- Event_classification(fi)
```

# Analysis
```{r}
source("scripts/Categories_time.R")
# Function to obtain ranges of glucose data, risk, and
# time of the day and time of the week of time points
fi <- Categories_time(fi)

```

## Diabetes measuraments
### glucose and insulin data summarize
```{r}
source("scripts/Summary_diabetes_measurements.R")
source("scripts/Utils.R")
Diabetes_summary <- Summary_diabetes_measures(glucose, fi, events)
```


```{r}
saveRDS(fi, paste0("out/Integration", Sys.Date() ,".rds"))
saveRDS(events, paste0("out/Events_", Sys.Date() ,".rds"))
writexl::write_xlsx(Diabetes_summary, paste0("out/stats_measurement_", Sys.Date(), ".xlsx"))
```

# Stats
## Chi-squared test for weekday and time day distribution of undesired events
```{r}
e2 <- events %>% 
  select(grep("type|AUC|ActI|extreme|N_bolus|timeday|weekday|start|end", names(.),value = T)) %>% 
  filter(Event_subtype != "Normoglycemia")

cq.hyper <- e2 %>% filter(Event_subtype == "Hyperglycemia") %>%  
              with(table(weekday))
cq.hyper
chisq.test(cq.hyper)
cq.hypo <- e2 %>% filter(Event_subtype == "Hypoglycemia") %>%  
              with(table(weekday))
cq.hypo
chisq.test(cq.hypo)

cq2.hyper <- e2 %>% filter(Event_subtype == "Hyperglycemia") %>%  
              with(table(timeday))
cq2.hyper
chisq.test(cq2.hyper)
cq2.hypo <- e2 %>% filter(Event_subtype == "Hypoglycemia") %>%  
              with(table(timeday))
cq2.hypo
chisq.test(cq2.hypo)

```
## regression
```{r}
e3 <- events %>% 
  filter(Event_subtype != "Normoglycemia") %>% 
  filter(complete.cases(.)) %>% 
  mutate(extrem.risk = 10*(1.509 * (log(extreme.value)^1.084 - 5.381)),
         slope.risk = 10*(1.509 * (log(Total_slope)^1.084 - 5.381)))
e3[is.infinite(e3$Diff_bolus),"Diff_bolus"] <- (time.bf+time.af)/60

# scaling and normalization
# select numerical variables for the model
num <- c("Total_slope", "Diff_bolus", "Bolus_ActI",
         "Basal_ActI", "Total_ActI", "N_bolus", "extrem.risk", "extreme.value")
X <- e3[,num] %>% scale(.)
# We calculate norma L2 using apply
L2 <- apply(X, 2, function(x) {sqrt(sum(x^2))})
# we divied each value for its respective norma L2
X <- X/L2
```

```{r}
cat <- c("Event_type", "Event_subtype", "weekday", "timeday")
lm.data <- cbind(e3[, cat], as.data.frame(X))
lm.data <- lm.data %>% 
  mutate(Event_subtype = factor(Event_subtype,
                             levels=c("Hypoglycemia", "Hyperglycemia"),
                             labels=c(0,1), ordered = T)
         )
```

### logistic regression
```{r}
lgm <- glm(Event_subtype ~ Total_slope + Diff_bolus + Bolus_ActI + 
            Basal_ActI + N_bolus + weekday + timeday,
            data= lm.data,
            family = binomial)
summary(lgm)
exp(coef(lgm))
```



# Plots
## Gluplot on hours
```{r load plots script}
source("scripts/Plots.R")
```

```{r gluplot, fig.height=20}
for(i in floor(runif(3, 1, nrow(events)))){
  print(gluplot(events[i,]))
}
```

## Percentile plots
```{r perplots, fig.height=24, fig.width=15}
perplot(fi)


for(i in levels(fi2$weekday)){
  x <- fi %>% filter(weekday == i)
  print(perplot(x, subtit=i))
}

for(i in levels(fi$timeday)){
  x <- fi %>% filter(timeday == i) %>% 
    mutate(hm = as.numeric(format(time, "%H%M"))) %>% 
    filter(hm < 2350)
  print(perplot(x, subtit=i, tx="5 mins"))
}


x <- fi2 %>% filter(meal_factor == "outmeal")
perplot(x, subtit="Outmeal")



## hyperglycemia
for(o in c("Hyperglycemia","Hypoglycemia")){
  x <- data.frame(matrix(nrow=0, ncol=length(fi2)))
  names(x) <- names(fi2)
  idx <- which(events$Event_subtype == o)
  for(i in idx){
    x0 <- fi2 %>% filter(time >= events[i,"start"] & time <= events[i,"end"])
    x <- rbind(x, x0)
  }
  print(perplot(x, subtit=o))
}
```

### meal percentile plots

```{r, fig.height=24, fig.width=15}
mealplot(fi)
```
## TIR plots
```{r}
TIR_plot(fi)
TIR_plot(fi, subset="weekday")
TIR_plot(fi, subset="timeday")
```

## Poincaré plot
```{r}
Poincare_plot(fi)
Poincare_plot(fi, subset = "weekday")
Poincare_plot(fi, subset = "timeday")
```


## Event-based clinical characteristics CVGA (24h periods)
we need to extract max and minim values for given time
```{r CVGA plots, fig.height=10, fig.width=10}
fi %>% 
  mutate(day = format(time, "%D")) %>% 
  group_by(day) %>% 
  summarize(Max = max(glucose, na.rm = T),
            Min = min(glucose, na.rm=T)) %>% 
  ebc.plot(tit="24h")

for(i in unique(fi$timeday)){
  fi %>% 
    mutate(day = format(time, "%D")) %>% 
    group_by(day, timeday) %>% 
    summarize(Max = max(glucose, na.rm = T),
              Min = min(glucose, na.rm=T)) %>% 
    filter(timeday == i) %>% 
    ebc.plot(tit=i) %>% print()
}

for(i in unique(fi$weekday)){
  fi %>% 
    mutate(day = format(time, "%D")) %>% 
    group_by(day, weekday) %>% 
    summarize(Max = max(glucose, na.rm = T),
              Min = min(glucose, na.rm=T)) %>% 
    filter(weekday == i) %>% 
    ebc.plot(tit=i) %>% print()
}


for(i in unique(fi$meal_factor[fi$meal_factor != "meal"])){
  fi %>% 
    mutate(day = format(time, "%D")) %>% 
    group_by(day, meal_factor) %>% 
    summarize(Max = max(glucose, na.rm = T),
              Min = min(glucose, na.rm=T)) %>% 
    filter(meal_factor == i) %>% 
    ebc.plot(tit=i) %>% print()
}
```





## boxplot
```{r}
Boxplot_glucose(fi)
Boxplot_glucose(fi, xaxis = "timeday", yaxis="risk")
```

## events plots
```{r}
Event_plot(fi, events)
Event_plot(fi, events, subset="timeday")
```






