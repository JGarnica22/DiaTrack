---
title: "Diabetes data analysis"
author: "Josep Garnica Caparrós"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: true
subtitle: Second round of TFH transfer experiment for the TR1 transcriptomics paper\n
Applying proper QC cutoffs.
---

```{r setup, include=F, message=F}
knitr::opts_knit$set(root.dir = 'C:/Users/Garnica/OneDrive - Universitat de Barcelona/Documentos/UOC/TFM/DiaTrack/')
knitr::opts_chunk$set(echo = F, warning = F,include=T, message=F, results="markup",
                      fig.path = "../figs/figs_rmarkdown/" ,dev="svg")
```

```{r libraries}
# source("R/functions.R") # call functions

library(tidyverse)
library(lubridate)
```

# Define parameters to use for analysis
## Diabetes manegement parameters

```{r}
#Set low and high threesholds:
low <- 70
high <- 180

source <- "xdrip"

#Arrange functions:
substract = function(a, b) {
  a - (b)
}

quan25 = function(x) {
  quantile(x,probs = 0.25, na.rm = T)
}
quan75 = function(x) {
  quantile(x,probs = 0.75, na.rm = T)
}
quan5 = function(x) {
  quantile(x,probs = 0.05, na.rm = T)
}
quan95 = function(x) {
  quantile(x,probs = 0.95, na.rm = T)
}
```
## Insuline model parameters
### old

```{r IoB function, eval=F}
insulin_duration <- 6*60 # 5 hours of duration
delay <- 7.6 # delay in first compartment, t
abs1 <- 0.0034 # absorbance rate from compartment 1 to plasma, ka1
abs2 <- 0.028 # absorbance rate from compartment 1 to 2, kd
abs3 <- 0.014 # absorbance rate from compartment 2 to plasma ka2
clear <- 0.124 # plasma clearance, ke
V1 <- 0.126 # L/kg

iob <- function(bolus, datetime, time_fractions = 1){
      df <- data.frame(matrix(nrow=0, ncol=9))
      names(df) <- c("dt", "tab","actI", "ins10", "ins20", "insP0",
                     "ins1", "ins2", "insP")
      time_after_bolus <- 0
      dt <- datetime
      while(time_after_bolus < insulin_duration){
        if(time_after_bolus <= delay){
          tab <- 0
          tf <- 0
        } else {
          tab <- time_after_bolus - delay
          tf <- time_fractions
        }
        
        if(tab <= 0){
          ins10 <- 0 + bolus # bolus
          ins20 <- 0
          insP0 <- 0
        } else{
          
          ins10 <- -(abs1 + abs2)*ins10*tf + ins10
          ins20 <- -abs3*ins20*tf + abs2*ins10*tf + ins20
          insP0 <- -clear*insP0*tf + abs1*ins10*tf +
                    abs3*ins20*tf + insP0
        }
  
            ins1 <- -(abs1 + abs2)*ins10*tf +
                      ins10
            ins2 <- -abs3*ins20*tf +
                      abs2*ins10*tf + ins20
            insP <- -clear*insP0*tf +
                      abs1*ins10*tf +
                      abs3*ins20*tf + insP0
          
          tmp <- data.frame(time = dt, tab=time_after_bolus, actI=insP/V1,
                            ins10=ins10, ins20=ins20, insP0=insP0,
                            ins1=ins1, ins2=ins2, insP=insP)
          df <- rbind(df, tmp)
          
          dt <- datetime + time_after_bolus*60
          time_after_bolus <- time_after_bolus + time_fractions
          
          
         
          
        }
      return(df[,c("time", "actI")])
      }
```
### new
```{r new IoB function}
insulin_duration <- 6*60 # 5 hours of duration
delay <- 7.6 # delay in first compartment, t
abs1 <- 0.0034 # absorbance rate from compartment 1 to plasma, ka1
abs2 <- 0.028 # absorbance rate from compartment 1 to 2, kd
abs3 <- 0.014 # absorbance rate from compartment 2 to plasma ka2
clear <- 0.124 # plasma clearance, ke
V1 <- 0.126 # L/kg
time_fractions <- 1

# precompute repeated calculations
abs1_abs2_tf <- (abs1 + abs2)*time_fractions
abs1_tf <- abs1 * time_fractions
abs3_tf <- abs3 * time_fractions
abs2_tf <- abs2 * time_fractions
clear_tf <- clear* time_fractions
start_plasma <- ceiling(delay)
time_after_bolus <- seq(0, insulin_duration, by = time_fractions)

iob <- function(bolus, datetime){
      
      time <- seq(datetime, datetime+insulin_duration*60, by=time_fractions*60)
      ins1 <- numeric(length(time_after_bolus))
      ins2 <- numeric(length(time_after_bolus))
      insP <- numeric(length(time_after_bolus))
      
      # initialize values until delay
      ins1[1:(start_plasma-1)] <- bolus
      ins2[1:(start_plasma-1)] <- 0
      insP[1:(start_plasma-1)] <- 0
      
     for(i in start_plasma:length(time_after_bolus)){    
            ins1[i] <- -abs1_abs2_tf*ins1[i-1] + ins1[i-1]
            ins2[i] <- -abs3_tf*ins2[i-1]+
                      abs2_tf*ins1[i-1] + ins2[i-1]
            insP[i] <- -clear_tf*insP[i-1] +
                      abs1_tf*ins1[i-1] +
                      abs3_tf*ins2[i-1] + insP[i-1]
        }
  
      dfn <- data.frame(time = time, actI=insP/V1)
 
        
      return(dfn)
      }
```

test function
```{r eval=F}
iob(5) %>%
  pivot_longer(-tab, names_to = "Compartment", values_to = "Ins") %>% 
  filter(!grepl("0",Compartment)) %>% 
  ggplot(aes(tab, Ins, color=Compartment))+
  geom_point()+
  ggprism::theme_prism()

d <- iob(5) %>%
  pivot_longer(-tab, names_to = "Compartment", values_to = "Ins") %>% 
  filter(!grepl("0",Compartment)) %>% mutate(bolus="5") 
de <- iob(20)  %>% 
  pivot_longer(-tab, names_to = "Compartment", values_to = "Ins") %>% 
  filter(!grepl("0",Compartment)) %>% mutate(bolus="20")
d3 <- rbind(d, de)

d3  %>% filter(Compartment == "actI") %>% 
  ggplot(aes(tab,Ins)) +
  geom_point(aes(color=bolus))

iob(5, comb[2,1]) %>% View()
iob(5, comb[2,1]) %>% 
  ggplot(aes(time, actI))+
  geom_point()
```

## Define dates to analyze
```{r}
#Set days to show:
days_to_show <- 90
#dates interval to show
from <- "2022-07-16"
to <- "2023-01-29"

```

## Load CGM data
```{r load data}
glu_path <- "data/export20230126-165100.csv"

if (source == "freestyle"){
#Import freestyle
#Start with a raw CSV file, as downloaded from the [Libreview](https://libreview.com) web application
#Load data
freestyler <- read.csv(glu_path, skip = 1)
#keep only date, time and glucose (mg.dL)
libre_raw <- freestyler[,c("Device.Timestamp","Historic.Glucose.mg.dL")]
libre_raw <- na.omit(libre_raw)
libre_raw$Device.Timestamp <- lubridate::force_tz(lubridate::dmy_hm(libre_raw$Device.Timestamp), Sys.timezone())
libre_raw$Device.Timestamp <- as_datetime(libre_raw$Device.Timestamp, tz = Sys.timezone())
glucose <- data.frame(time=as_datetime(libre_raw$Device.Timestamp), glucose=libre_raw$Historic.Glucose.mg.dL)
glucose <- glucose %>% filter(!is.na(glucose))
} else if (source == "xdrip"){
  xdrip <- read.csv(glu_path, sep = ";")
  glucose <- data.frame(time=paste(xdrip$DAY, xdrip$TIME), glucose = xdrip$UDT_CGMS)
  glucose$time <- lubridate::force_tz(lubridate::dmy_hm(glucose$time), Sys.timezone())
  glucose$time <- as_datetime(glucose$time, tz = Sys.timezone())
  glucose <- glucose %>% filter(!is.na(glucose))
} 


## missing!! remove noise values!!
```

glucose
## Check glucose noise
Downloaded data already is fine!

## Compute slopes of glucose trends
Compute slope of glucoe per minute
```{r}
glucose$slope <- NA
for(i in 2:nrow(glucose)){
  glucose[i,"slope"] <- (glucose[i,"glucose"] - glucose[(i-1),"glucose"])/
                          as.numeric(glucose[i,"time"] - glucose[(i-1),"time"])
}
glucose$slope15 <- NA
i <- 4
while(i <= nrow(glucose)){
  glucose[i,"slope15"] <- (glucose[i,"glucose"] - glucose[(i-3),"glucose"])/
                          as.numeric(glucose[i,"time"] - glucose[(i-3),"time"])
  i <- i + 3
}


```



## Load Insulin pump data
all insulin
```{r}
ins_path <- "data/Josep Garnica Caparrós 8-3-2023.csv"
ins <- read.csv2(ins_path, skip = 6, header = T) %>% 
  replace(.=="",NA) %>% 
  mutate(Index = as.numeric(Index),
         time2 = as_datetime(
           lubridate::force_tz(lubridate::ymd_hms(paste(Date, Time)),
                                                 Sys.timezone()),
                             tz = Sys.timezone()),
         time2 = floor_date(time2, "minute")) %>% 
  filter(!is.na(Index)) %>% 
  dplyr::select(-Index)


```
split insulin dataset
```{r}
bas <- c("Basal.Rate..U.h.","Temp.Basal.Amount",
         "Temp.Basal.Type","Temp.Basal.Duration..h.mm.ss.")
Basal <- ins[,c("time2", bas)] %>% rename(time = "time2")

bol <- c("Bolus.Volume.Delivered..U.","Bolus.Type",
         "Bolus.Duration..h.mm.ss.")
bolus <- ins[,c("time2", bol)] %>% rename(time = "time2") %>% 
  filter(!is.na(Bolus.Volume.Delivered..U.))
```

## Dataset combining Glucose and insulin
```{r}
##  define period to analyse
from <- as_datetime(lubridate::force_tz(lubridate::ymd_hms(paste(from, "00:00:00")),
                                                 Sys.timezone()),
                             tz = Sys.timezone())
to <- as_datetime(lubridate::force_tz(lubridate::ymd_hms(paste(to, "00:00:00")),
                                                 Sys.timezone()),
                             tz = Sys.timezone())

```

```{r}
time_range <- seq(from,to, 60) # create a dataset in minute sequence
comb00 <- data.frame(time = time_range)
comb0 <- comb00 %>% arrange(time) %>%
  mutate(
         Bolus_type = NA,
         Injec_bolus = 0, # Bolus delivered
         )

```

### bolus
```{r}
narows <- bolus[,-1] %>% 
  is.na() %>% 
  {rowSums(.) == ncol(.)}
bolus <- bolus[narows == F,]
comb <- left_join(comb0, bolus, by="time") %>% arrange(time)
i <- 1
bs <- NA
while(i <= nrow(comb)){
  if (comb[i,"Bolus.Volume.Delivered..U."] == "" |
      is.null(comb[i,"Bolus.Volume.Delivered..U."]) |
      is.na(comb[i,"Bolus.Volume.Delivered..U."])){
      i <- i + 1 
    }
  else if(grepl("normal", comb[i,"Bolus.Type"], ignore.case = T)){
    comb[i,"Injec_bolus"] <- as.numeric(comb[i,"Bolus.Volume.Delivered..U."]) +
                              comb[i,"Injec_bolus"]
    comb[i,"Bolus_type"] <- "Normal"
    i <- i + 1
  } else if(grepl("square", comb[i,"Bolus.Type"], ignore.case = T)){
    comb[i,"Bolus_type"] <- "End_Square"
    m <- hms(comb[i,]$Bolus.Duration..h.mm.ss.)
    m <- hour(m)*60 + minute(m)
    bsquare <- as.numeric(comb[i,"Bolus.Volume.Delivered..U."])/m
      for(o in 1:m){
        o <- i - o
        comb[o, "Injec_bolus"] <- comb[o, "Injec_bolus"] + bsquare
      }
    if(is.na(comb[o,"Bolus_type"])){
    comb[o,"Bolus_type"] <- "Start_Square"
    } else {comb[o+1,"Bolus_type"] <- "Start_Square"}
    i <- i +1
  }
  
}

comb_bolus <- comb %>% 
  dplyr::select(time, Bolus_type, Injec_bolus) %>% 
  distinct()


```

### basal
```{r}
comb0 <- comb00 %>% mutate(
          Action = NA, # Bolus, type of bolus, change reservoir
         Basal_rate = NA, # Basal rate/h
         Injec_basal = NA) # Basal insulin administered
         

narows <- Basal[,-1] %>% 
  is.na() %>% 
  {rowSums(.) == ncol(.)}
Basal <- Basal[narows == F,]
comb <- left_join(comb0, Basal, by="time") %>% arrange(time) %>% 
  distinct()


i <- 1
bs <- NA
while(i <= nrow(comb)){
  if((is.na(comb[i,"Basal.Rate..U.h."])|is.null(comb[i,"Basal.Rate..U.h."]))&
        is.na(comb[i,"Temp.Basal.Amount"]) == T){
    comb[i, "Basal_rate"] <- bs
    i <- i + 1
  } else if ((comb[i,"Temp.Basal.Amount"] == "" | is.na(comb[i,"Temp.Basal.Amount"]))&
              !is.na(comb[i,"Basal.Rate..U.h."]) == T){
    bs <- as.numeric(comb[i,"Basal.Rate..U.h."])
    comb[i, "Basal_rate"] <- bs
    i <- i+1
  } else if(comb[i,"Temp.Basal.Type"] == "Rate"){
      bst <- comb[i, "Temp.Basal.Amount"]
      m <- hms(comb[i,]$Temp.Basal.Duration..h.mm.ss.)
      m <- hour(m)*60 + minute(m)
      comb[i, "Action"] <- "Temporal_basal_start"
    for(o in 1:m){
      comb[i, "Basal_rate"] <- as.numeric(bst)
      i <- i + 1
      if(i > nrow(comb)){break}
    }
      comb[i, "Action"] <- "Temporal_basal_end"
  } else if(comb[i,"Temp.Basal.Type"] == "Percent"){
      m <- hms(comb[i,]$Temp.Basal.Duration..h.mm.ss.)
      m <- hour(m)*60 + minute(m)
      comb[i, "Action"] <- "Temporal_basal_start"
      f <- as.numeric(comb[i,"Temp.Basal.Amount"])/100
      bst <- f*as.numeric(comb[i-2,"Basal_rate"])
    for(o in 1:m){
        if(is.na(comb[i,"Basal.Rate..U.h."])){
          bst <- bst
        } else{
        bst <- f*as.numeric(comb[i,"Basal.Rate..U.h."])
      }
      comb[i, "Basal_rate"] <- as.numeric(bst)
      i <- i + 1
      if(i > nrow(comb)){break}
    }
      comb[i, "Action"] <- "Temporal_basal_end"
  }
}

comb_basal <- comb %>% 
  dplyr::select(time, Action, Basal_rate, Injec_basal) %>% 
  distinct() %>% 
  filter(!is.na(Basal_rate)) %>% 
  mutate(Injec_basal = Basal_rate/60)
  
```
## compute active insulin

```{r old version, eval=F}
tins <- full_join(comb_bolus, comb_basal, by="time") %>% distinct()

print(paste("Start bolus actI:", Sys.time()))
nr <- which(tins$Injec_bolus > 0)
names(nr) <- seq(1:length(nr))

for(i in 1:length(nr)){
    bolus <- tins[nr[i],"Injec_bolus"]
    datetime <- tins[nr[i], "time"]
    tmp <- iob(bolus, datetime)
    tins <- left_join(tins, tmp, by="time")
    tins[is.na(tins$actI),"actI"] <- 0
    tins <- tins %>% mutate(Bolus_ActI = Bolus_ActI + actI) %>% 
      dplyr::select(-actI)
    
    # pb <- winProgressBar(title = "progress bar", min = 0,
    #                      max =length(nr) , width = 300)
    # Sys.sleep(0.1)
    # setWinProgressBar(pb, i, title=paste( round(i/length(nr)*100, 0),"% done"))
  }
# close(pb)
print(paste("Start basal actI:", Sys.time()))
nr <- which(tins$Injec_basal > 0)
names(nr) <- seq(1:length(nr))

for(i in 1:length(nr)){
    ba <- tins[nr[i],"Injec_basal"]
    datetime <- tins[nr[i], "time"]
    tmp <- iob(ba, datetime)
    tins <- left_join(tins, tmp, by="time")
    tins[is.na(tins$actI),"actI"] <- 0
    tins <- tins %>% mutate(Basal_ActI = Basal_ActI + actI) %>% 
      dplyr::select(-actI)
    
    # pb <- winProgressBar(title = "progress bar", min = 0,
    #                      max =length(nr) , width = 300)
    # Sys.sleep(0.1)
    # setWinProgressBar(pb, i, title=paste( round(i/length(nr)*100, 0),"% done"))
}
# close(pb)
print(paste("Finish basal actI:", Sys.time()))

```

```{r foerach version}
require(foreach)
require(doParallel)

tins <- full_join(comb_bolus, comb_basal, by="time") %>% distinct() %>% 
  filter(!is.na(time))

print(paste("Start bolus actI:", Sys.time()))
nr <- which(tins$Injec_bolus > 0)
names(nr) <- seq(1:length(nr))

#open cluster (15)
workers <- detectCores()-1
cluster <- makeCluster(workers) 
registerDoParallel(cluster)

temp_bolus <- foreach(i = 1:length(nr)) %dopar% {
                bolus <- tins[nr[i],"Injec_bolus"]
                datetime <- tins[nr[i], "time"]
                t <- iob(bolus, datetime)
              }
stopCluster(cluster)

res <- data.table::rbindlist(temp_bolus)

temp_bolus <- res %>% group_by(time) %>% 
              summarize(Bolus_ActI = sum(actI))
tins <- left_join(tins, temp_bolus, by="time")


print(paste("Start basal actI:", Sys.time()))
nr <- which(tins$Injec_basal > 0)
names(nr) <- seq(1:length(nr))

workers <- detectCores()-1
cluster <- makeCluster(workers) 
registerDoParallel(cluster)

temp_basal <- foreach(i = 1:length(nr)) %dopar% {
                ba <- tins[nr[i],"Injec_basal"]
                datetime <- tins[nr[i], "time"]
                t <- iob(ba, datetime)
                
              }
stopCluster(cluster)
print(paste("Finish basal actI:", Sys.time()))

res <- data.table::rbindlist(temp_basal)

temp_basal <- res %>% group_by(time) %>% 
              summarize(Basal_ActI = sum(actI))
tins <- left_join(tins, temp_basal, by="time")
tins[is.na(tins$Bolus_ActI),"Bolus_ActI"] <- 0
tins <- tins %>% mutate(Total_ActI=Bolus_ActI+Basal_ActI)

```
for each trial
```{r eval=F}
library(foreach)
library(doParallel)

chunk <- function(x, size) {
  n <- length(x)
  num_chunks <- ceiling(n / size)
  split(x, rep(1:num_chunks, each = size)[seq_len(n)])
}

tins2 <- tins0[1:2000,]
nr <- which(tins2$Injec_basal > 0)
names(nr) <- seq(1:length(nr))


workers <- detectCores()-1
cluster <- makeCluster(workers) 
registerDoParallel(cluster)
l <- 0
start_t <- Sys.time()

cx <- foreach(i = 1:length(nr), .combine=cbind) %dopar% {

                ba <- tins2[nr[i],"Injec_basal"]
                datetime <- tins2[nr[i], "time"]
                cx <- iob(ba, datetime)
                cx
}
end_time <- Sys.time()
  elapsed_time <- end_time - start_t
stopCluster(cluster)
print(sum(cx$l))
print(mean(cx$l))
print(elapsed_time)

res_list <- list()
for(o in seq(1,ncol(cx),2)){
  res_list[[o]] <- cx[,o:(o+1)]
}
res <- do.call("rbind", res_list)


bolus_list <- c(10, 20, 30)  # example list of bolus values
datetime_list <- c("2023-04-01 08:00:00", "2023-04-01 09:00:00", "2023-04-01 10:00:00")  # example list of datetimes

iob_list <- mapply(iob, bolus = tins[tins2$Injec_basal > 0, "Injec_basal"],
                   datetime = tins[tins2$Injec_basal > 0, "time"],
                   SIMPLIFY = FALSE)
```



### Merge
```{r}
fi <- left_join(tins, glucose, by="time")
```

## Remove not needed rows
```{r}
fi2 <- fi %>% filter(!is.na(glucose) | !is.na(Bolus_type) | !is.na(Action))

```

# Classify events
Create a new dataframe with the events in this period of time
```{r}
sl.th <- 2 # threshold for glu falling or rising fast
time.bf <- 90*60 #time analysis before event in minutes (1.5h)
time.af <- 180*60 # time analysis after event in minuts (3h)

vars <- c("Event_type", 
          "start", "end",
          "weekday", "timeday",
          "Event_subtype","extreme.value", "AUC_out_range",
          "Total_slope", "Diff_bolus", "Bolus_ActI",
          "Basal_ActI", "Total_ActI", "N_bolus", "Overcorrection")
events <- data.frame(matrix(nrow=0, ncol=length(vars)))
names(events) <- vars

#discard first values as we cannot get before data
s <- min(fi2$time) + time.bf
loo <- which(fi2$time > s & !is.na(fi2$glucose))
o <- 1
done <- c()
for(i in loo){
  if(!i %in% done){
  if(fi2[i, "slope"] > sl.th){
    events[o,"Event_type"] <- "Meal"
    start <- fi2[i, "time"]-time.bf
    end <- fi2[i, "time"]+time.af
    events[o,"start"] <- start
    events[o,"end"] <- end
    # create temp dataframe with data
    tmp <- fi2[fi2$time >= start & fi2$time <= end,]
    # distance with bolus
    earliest_bolus_time <- min(tmp$time[!is.na(tmp$Bolus_type)])
    events[o,"Diff_bolus"] <- abs(as.numeric(difftime(fi2[i, "time"],
                                      earliest_bolus_time,
                                    units= "mins")))
    events[o, "N_bolus"] <- nrow(tmp[!is.na(tmp$Bolus_type),])
    
    if(length(tmp$glucose[tmp$glucose > high & !is.na(tmp$glucose)])>3){
      events[o,"Event_subtype"] <- "Hyperglycemia"
      out_thres <- which(tmp$glucose > high)
      #highest value
      extrem <- max(tmp$glucose[!is.na(tmp$glucose)])
      extrem_time <- min(tmp[tmp$glucose == extrem &
                                            !is.na(tmp$glucose),"time"])
      events[o, "extreme.value"] <- extrem
      
      # Total slope
      time_prev_max <- tmp %>% dplyr::filter(!is.na(glucose)) %>% 
                        dplyr::filter(glucose < high) %>% 
                        dplyr::filter(time < extrem_time) %>% 
                        dplyr::pull(time) %>%  max()
      sslope <- min(tmp[tmp$time > start &
                      tmp$time < time_prev_max &
                    !is.na(tmp$glucose),"glucose"])
      difslope <- as.numeric(difftime(time_prev_max,
                                      min(tmp$time[tmp$glucose == sslope &
                                        !is.na(tmp$glucose)]),
                              units= "mins"))
      events[o, "Total_slope"] <- (events[o, "extreme.value"] - sslope) / 
                                            difslope
      
      time <- as.numeric(difftime(tmp$time[out_thres],
                                  tmp$time[out_thres][1],
                                  units="mins"))
      glu <- tmp$glucose[out_thres]
      glu <- ifelse(glu > high,
                        abs(glu - high),
                        0)
      interp <- approx(time, glu)
      auc <- DescTools::AUC(interp$x, interp$y)
      events[o, "AUC_out_range"] <- auc
      #ovecorrection
      if(length(tmp$glucose[tmp$glucose < low & !is.na(tmp$glucose)])>3){
        events[o,"Overcorrection"] <- "Yes"
      }
      
      # Active insulin
       if(!is.finite(time_prev_max)){
        for(a in c("Bolus_ActI",
            "Basal_ActI", "Total_ActI")){
        events[o,a] <- tmp[tmp$glucose > high, a][1]
        }
      } else {
        for(a in c("Bolus_ActI",
            "Basal_ActI", "Total_ActI")){
        events[o,a] <- tmp[tmp$time == time_prev_max, a][1]
        }
      }
      
    } else if(length(tmp$glucose[tmp$glucose < low & !is.na(tmp$glucose)])>3){
      events[o,"Event_subtype"] <- "Hypoglycemia"
      out_thres <- which(tmp$glucose < low)
      #lowest value
      extrem <- min(tmp$glucose[!is.na(tmp$glucose)])
      extrem_time <- min(tmp[tmp$glucose == extrem &
                                            !is.na(tmp$glucose),"time"])
      events[o, "extreme.value"] <- extrem
      
      # Total slope
       time_prev_max <- tmp %>% dplyr::filter(!is.na(glucose)) %>% 
                        dplyr::filter(glucose > low) %>% 
                        dplyr::filter(time < extrem_time) %>% 
                        dplyr::pull(time) %>%  min()
      sslope <- min(tmp[tmp$time > start &
                      tmp$time < time_prev_max &
                    !is.na(tmp$glucose),"glucose"])
      difslope <- as.numeric(difftime(time_prev_max,
                                      min(tmp[tmp$glucose == sslope &
                                        !is.na(tmp$glucose), "time"]),
                              units= "mins"))
      events[o, "Total_slope"] <- (events[o, "extreme.value"] - sslope) / 
                                            difslope
      
      time <- as.numeric(difftime(tmp$time[out_thres],
                                  tmp$time[out_thres][1],
                                  units="mins"))
      glu <- tmp$glucose[out_thres]
      glu <- ifelse(glu < low,
                        abs(glu - low),
                        0)
      interp <- approx(time, glu)
      auc <- DescTools::AUC(interp$x, interp$y)
      events[o, "AUC_out_range"] <- auc
       #ovecorrection
      if(length(tmp$glucose[tmp$glucose > high & !is.na(tmp$glucose)])>3){
        events[o,"Overcorrection"] <- "Yes"
      }
      # Active insulin
      if(!is.finite(time_prev_max)){
        for(a in c("Bolus_ActI",
            "Basal_ActI", "Total_ActI")){
        events[o,a] <- tmp[tmp$glucose < low, a][1]
        }
      } else {
        for(a in c("Bolus_ActI",
            "Basal_ActI", "Total_ActI")){
        events[o,a] <- tmp[tmp$time == time_prev_max, a][1]
        }
      }
      
    } else {
      events[o,c("extreme.value", "AUC_out_range",
          "Total_slope", "Diff_bolus")] <- NA
      events[o,"Event_subtype"] <- "Normoglycemia"
    }
      done <- append(done, as.numeric(rownames(tmp)))
      o <- o +1
    }
  }
}

for(i in loo[!loo %in% done]){
  if(!i %in% done){
  if(length(fi2[i:(i+4), "glucose"][fi2[i:(i+4), "glucose"] > high &
                                    !is.na(fi2[i:(i+4), "glucose"])])>3){
  events[o,"Event_type"] <- "No_Meal"
  start <- fi2[i, "time"]-time.bf
  end <- fi2[i, "time"]+time.af
  events[o,"start"] <- start
  events[o,"end"] <- end
  # create temp dataframe with data
  tmp <- fi2[fi2$time >= start & fi2$time <= end,]
  # distance with bolus
  earliest_bolus_time <- min(tmp[!is.na(tmp$Bolus_type), "time"])
  events[o,"Diff_bolus"] <- abs(as.numeric(difftime(fi2[i, "time"],
                                                    earliest_bolus_time,
                                                    units= "mins")))
  events[o, "N_bolus"] <- nrow(tmp[!is.na(tmp$Bolus_type),])
  events[o,"Event_subtype"] <- "Hyperglycemia"
  out_thres <- which(tmp$glucose > high)
  #highest value
  extrem <- max(tmp$glucose[!is.na(tmp$glucose)])
  extrem_time <- min(tmp[tmp$glucose == extrem &
                           !is.na(tmp$glucose),"time"])
  events[o, "extreme.value"] <- extrem
  
  # Total slope
  time_prev_max <- tmp %>% dplyr::filter(!is.na(glucose)) %>% 
    dplyr::filter(glucose < high) %>% 
    dplyr::filter(time < extrem_time) %>% 
    dplyr::pull(time) %>%  max()
    sslope <- min(tmp[tmp$time > start &
                        tmp$time < time_prev_max &
                        !is.na(tmp$glucose),"glucose"])
    difslope <- as.numeric(difftime(time_prev_max,
                                    min(tmp[tmp$glucose == sslope &
                                          !is.na(tmp$glucose), "time"]),
                                    units= "mins"))
    events[o, "Total_slope"] <- (events[o, "extreme.value"] - sslope) / 
      difslope
    
    time <- as.numeric(difftime(tmp$time[out_thres],
                                tmp$time[out_thres][1],
                                units="mins"))
    glu <- tmp$glucose[out_thres]
    glu <- ifelse(glu > high,
                      abs(glu - high),
                      0)
    interp <- approx(time, glu)
    auc <- DescTools::AUC(interp$x, interp$y)
    events[o, "AUC_out_range"] <- auc
    if(length(fi2[i:(i+4), "glucose"][fi2[i:(i+4), "glucose"] < low &
                                    !is.na(fi2[i:(i+4), "glucose"])])>3){
      events[o, "Overcorrection"] <- "Yes"
    }
    
    # Active insulin
      if(!is.finite(time_prev_max)){
        for(a in c("Bolus_ActI",
            "Basal_ActI", "Total_ActI")){
        events[o,a] <- tmp[tmp$glucose > high, a][1]
        }
      } else {
        for(a in c("Bolus_ActI",
            "Basal_ActI", "Total_ActI")){
        events[o,a] <- tmp[tmp$time == time_prev_max, a][1]
        }
      }
      done <- append(done, as.numeric(rownames(tmp)))
      o <- o +1
  } else if(length(fi2[i:(i+4), "glucose"][fi2[i:(i+4), "glucose"] < low &
                                    !is.na(fi2[i:(i+4), "glucose"])])>3){
    events[o,"Event_type"] <- "No_Meal"
    start <- fi2[i, "time"]-time.bf
    end <- fi2[i, "time"]+time.af
    events[o,"start"] <- start
    events[o,"end"] <- end
  # create temp dataframe with data
    tmp <- fi2[fi2$time >= start & fi2$time <= end,]
  # distance with bolus
    earliest_bolus_time <- min(tmp[!is.na(tmp$Bolus_type), "time"])
    events[o,"Diff_bolus"] <- abs(as.numeric(difftime(fi2[i, "time"],
                                                    earliest_bolus_time,
                                                    units= "mins")))
    events[o, "N_bolus"] <- nrow(tmp[!is.na(tmp$Bolus_type),])
    events[o,"Event_subtype"] <- "Hypoglycemia"
    out_thres <- which(tmp$glucose < low)
  #lowest value
    extrem <- min(tmp$glucose[!is.na(tmp$glucose)])
    extrem_time <- min(tmp[tmp$glucose == extrem &
                           !is.na(tmp$glucose),"time"])
    events[o, "extreme.value"] <- extrem
  
  # Total slope
  time_prev_max <- tmp %>% dplyr::filter(!is.na(glucose)) %>% 
                        dplyr::filter(glucose > low) %>% 
                        dplyr::filter(time < extrem_time) %>% 
                        dplyr::pull(time) %>%  min()
    sslope <- min(tmp[tmp$time > start &
                        tmp$time < time_prev_max &
                        !is.na(tmp$glucose),"glucose"])
    difslope <- as.numeric(difftime(time_prev_max,
                                    min(tmp[tmp$glucose == sslope &
                                          !is.na(tmp$glucose), "time"]),
                                    units= "mins"))
    events[o, "Total_slope"] <- (events[o, "extreme.value"] - sslope) / 
      difslope
    
    time <- as.numeric(difftime(tmp$time[out_thres],
                                tmp$time[out_thres][1],
                                units="mins"))
    glu <- tmp$glucose[out_thres]
    glu <- ifelse(glu < low,
                        abs(glu - low),
                        0)
    interp <- approx(time, glu)
    auc <- DescTools::AUC(interp$x, interp$y)
    events[o, "AUC_out_range"] <- auc
    if(length(fi2[i:(i+4), "glucose"][fi2[i:(i+4), "glucose"] > high &
                                    !is.na(fi2[i:(i+4), "glucose"])])>3){
      events[o, "Overcorrection"] <- "Yes"
    }
    
    # Active insulin
     if(!is.finite(time_prev_max)){
        for(a in c("Bolus_ActI",
            "Basal_ActI", "Total_ActI")){
        events[o,a] <- tmp[tmp$glucose < low, a][1]
        }
      } else {
        for(a in c("Bolus_ActI",
            "Basal_ActI", "Total_ActI")){
        events[o,a] <- tmp[tmp$time == time_prev_max, a][1]
        }
      }
      done <- append(done, as.numeric(rownames(tmp)))
      o <- o +1
  }

  }
}

events$Total_ActI <- ifelse(is.na(events$Total_ActI),
                            events$Basal_ActI,
                            events$Total_ActI)
events$Overcorrection[is.na(events$Overcorrection)] <- "No"

```

# Analysis
```{r}
fi2 <- fi2 %>% 
    arrange(time) %>% 
    mutate(Range = ifelse(glucose<55, "Very low",
                        ifelse(glucose<low, "Low",
                        ifelse(glucose>=low &
                                 glucose< high, "In range",
                        ifelse(glucose>=high &
                                 glucose<= 240, "High",
                               "Very high")))),
          Range = factor(Range,
                        levels=c("Very low", "Low",
                                 "In range", "High", "Very high")),
          time= as_datetime(lubridate::force_tz(lubridate::ymd_hms(time),
                                                 Sys.timezone()),
                             tz = Sys.timezone())
    )


```

## Gold-starndard diabetes measuraments
### data
Use and improve gold standards overall measurements of diabetes management: mean, median, deviation, number of highs/lows, time out of range…
BGRI https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2903980/
10*(1.509 * log(glucose)^1.084 - 5.381)
high > 0
low < 0
total =  high + low
LBGI ≤ 1.1; low risk, 1.1 < LBGI ≤ 2.5; moderate risk, 2.5 < LBGI ≤ 5; and high risk, LBGI > 5
two cutoff points—4.5 and 9—have been identified for the HBGI separating low, moderate, and high risk for hyperglycemia
rate change: slope https://diabetesjournals.org/care/article/27/9/2161/22635/Rates-of-Glucose-Change-Measured-by-Blood-Glucose (system stability) mg/dL/min

Variation coeficient: CV of glucose (should be <=36%) = SD/mean * 100

GMI (%) = 3.31 + 0.02392 × mean glucose concentration
```{r}
mes.glu <- data.frame(matrix(nrow=0, ncol=3))
stats.glu <- c("Sensor coverage", "SG mean & SD",
               "SG mean & SD premeal", "SG mean & SD postmeal",
               "SG mean & SD outmeal",
           "GMI", "Variation coeficient", "BGRI", "LBGI", "HBGI",
           "BGRI premeal", "LBGI premeal", "HBGI premeal",
           "BGRI postmeal", "LBGI postmeal", "HBGI postmeal",
           "BGRI outmeal", "LBGI outmeal", "HBGI outmeal",
           "Variation coeficient of risk",
           "SD Rate of Change", "% values outside [-2,2] range",
           "N hypoglycemia/day", "N hyperglycemia/day",
           "Time in range (TIR)", "Time in hyperglycemia",
           "Time in hypoglycemia", "Time in extreme hyperglycemia",
           "Time in extreme hypoglycemia", "Week day with best TIR",
           "Time of day with best TIR",
           "Week day with highest HBGI",
           "Time of day with highest HBGI",
           "Week day with lowest LBGI",
           "Time of day with highest LBGI",
           "N hypoglycemia overcorrection",
           "N hyperglycemia overcorrection")
goal <- c()
```

#### Add meal factor into the fi2 dataframe
```{r}
# premeal, postmeal or outmeal
fi2$meal_factor <- "outmeal"
fi2$mealtime <- NA
i <- 1
while(i <= nrow(fi2)){
  if(!is.na(fi2[i, "slope"])){
    if(fi2[i, "slope"] > sl.th){
      fi2[i,"meal_factor"] <- "meal"
      fi2[i, "mealtime"] <- 0
      tb <- fi2[i,"time"]
      fi2[fi2$time > (tb - time.bf) & fi2$time < tb, "meal_factor"] <- "premeal"
      fi2[fi2$time > (tb - time.bf) & fi2$time < tb, "mealtime"] <-
        (fi2[fi2$time > (tb - time.bf) & fi2$time < tb, "time"] - tb)
      fi2[fi2$time < (tb + time.af) & fi2$time > tb, "meal_factor"] <- "postmeal"
      fi2[fi2$time < (tb + time.af) & fi2$time > tb, "mealtime"] <-
        (fi2[fi2$time < (tb + time.af) & fi2$time > tb, "time"] - tb)
      i <- max(which(fi2$time < (tb + time.af)))
    }
  }
  i <- i+1
}
# setting time of day
morning <- c(7,12)
midday <- c(13,15)
afternoon <- c(16,19)
evening <- c(20,23)
nigth <- c(0,6)

# day of the week
fi2 <- fi2 %>% 
  mutate(weekday = factor(weekdays(fi2$time),
                          levels=c("lunes","martes","miércoles",
                                   "jueves", "viernes","sábado",
                                   "domingo" ),
                          labels=c("Monday", "Tuesday",
                                   "Wednesday", "Thursday",
                                   "Friday", "Saturday",
                                   "Sunday")),
         # time of day morning, midday, afternoon, evening, night
         timehour = as.numeric(format(fi2$time, "%H")),
         timeday = ifelse(timehour >= morning[1] & timehour <= morning[2],
                          "morning",
                          ifelse(timehour >= midday[1] & timehour <= midday[2],
                                 "midday",
                           ifelse(timehour >= afternoon[1] & timehour <= afternoon[2],
                                  "afternoon",
                              ifelse(timehour >= evening[1] & timehour <= evening[2],
                                     "evening",
                                ifelse(timehour >= nigth[1] & timehour <= nigth[2],
                                       "night", NA)
                            )))),
         timeday = factor(timeday,
                          levels=c("morning","midday", "afternoon",
                                   "evening","night"))
                  )
                                


```

#### Calculate risk
```{r}
fi2 <- fi2 %>% 
  mutate(risk = 10*(1.509 * (log(glucose)^1.084 - 5.381)))
```

## Compute measureaments
```{r}
stats.glu <- c("Days of analysis", "Sensor coverage", "SG mean & SD",
               "SG mean & SD premeal", "SG mean & SD postmeal",
               "SG mean & SD outmeal",
           "GMI", "Variation coeficient", "BGRI", "LBGI", "HBGI",
           "BGRI premeal", "LBGI premeal", "HBGI premeal",
           "BGRI postmeal", "LBGI postmeal", "HBGI postmeal",
           "BGRI outmeal", "LBGI outmeal", "HBGI outmeal",
           "Variation coeficient of risk",
           "SD Rate of Change", "% values outside [-2,2] range",
           "N hypoglycemia/day", "N hyperglycemia/day",
           "Time in range (TIR)", "Time in hyperglycemia",
           "Time in hypoglycemia", "Time in extreme hyperglycemia",
           "Time in extreme hypoglycemia", "Week day with worst TIR",
           "Time of day with worst TIR",
           "Week day with highest HBGI",
           "Time of day with highest HBGI",
           "Week day with highest LBGI",
           "Time of day with highest LBGI",
           "% hypoglycemia overcorrection",
           "% hyperglycemia overcorrection")

# time_bw_sens <- c()
# for(i in 2:nrow(glucose)){
#   if(!is.na(glucose[i-1,"glucose"]-glucose[i,"glucose"])){
#   d <- abs(as.numeric(glucose[i-1,"time"]-glucose[i,"time"]))
#   if(!is.na(d)){
#     time_bw_sens <- append(time_bw_sens, d)
#   }
#   }
# }
# mean(time_bw_sens)
# hist(time_bw_sens)
#time_bw_sens[time_bw_sens > 15]

sensor_not_coverage <- 0
for(i in 2:nrow(glucose)){
  if(!is.na(glucose[i-1,"glucose"]-glucose[i,"glucose"])){
    d <- abs(as.numeric(glucose[i-1,"time"]-glucose[i,"time"]))
    if(!is.na(d)){
      if(d>5){
        sensor_not_coverage <- sensor_not_coverage + (d-5)
      }
    }
  }
}
sensor_coverage <-  round(100*(as.numeric(to - from)*24 - sensor_not_coverage/60)/
                      (as.numeric(to - from)*24),1)
N_days_analysis <- floor(as.numeric(to - from))

df1 <- data.frame(Stat=c("Days of analysis", "Sensor coverage"),
                  Value=c(N_days_analysis, sensor_coverage))
# at least 70%
```

#### summarize
```{r}
glu.mes.global <-
  fi2 %>%
  summarize(`SG mean & SD` = paste0(round(mean(glucose,na.rm = T),1),
                                    " \u00B1 ",
                                    round(sd(glucose, na.rm=T),1)),
            `SG mean & SD (premeal)` = paste0(round(mean(glucose[meal_factor == "premeal"],
                                                         na.rm = T),1),
                                    " \u00B1 ",
                                    round(sd(glucose[meal_factor == "premeal"],
                                             na.rm=T),1)),
            `SG mean & SD (postmeal)` = paste0(round(mean(glucose[meal_factor == "postmeal"],
                                                         na.rm = T),1),
                                    " \u00B1 ",
                                    round(sd(glucose[meal_factor == "postmeal"],
                                             na.rm=T),1)),
            `SG mean & SD (outmeal)` = paste0(round(mean(glucose[meal_factor == "outmeal"],
                                                         na.rm = T),1),
                                    " \u00B1 ",
                                    round(sd(glucose[meal_factor == "outmeal"],
                                             na.rm=T),1)),
            CV = round(sd(glucose, na.rm=T)/mean(glucose,na.rm = T) * 100,2),
            `CV (premeal)` = round(sd(glucose[meal_factor == "premeal"], na.rm=T)/
                                     mean(glucose[meal_factor == "premeal"],na.rm = T) * 100,2),
            `CV (postmeal)` = round(sd(glucose[meal_factor == "postmeal"], na.rm=T)/
                                     mean(glucose[meal_factor == "postmeal"],na.rm = T) * 100,2),
            `CV (outmeal)` = round(sd(glucose[meal_factor == "outmeal"], na.rm=T)/
                                     mean(glucose[meal_factor == "outmeal"],na.rm = T) * 100,2),
            GMI = round(3.31+0.02392*mean(glucose,na.rm = T),2),
            
            BGRI = round(mean(risk[risk < 0],na.rm = T),1)+
              round(mean(risk[risk > 0],na.rm = T),1),
            LBGI = paste0(-round(mean(risk[risk < 0],na.rm = T),1),
                          " \u00B1 ",
                          round(sd(risk[risk < 0],na.rm = T),1)),
            `CV LBGI` = round(sd(risk[risk < 0],na.rm = T)/
                                -mean(risk[risk < 0],na.rm = T) * 100,2),
            HBGI = paste0(round(mean(risk[risk > 0],na.rm = T),1),
                          " \u00B1 ",
                          round(sd(risk[risk > 0],na.rm = T),1)),
            `CV HBGI` = round(sd(risk[risk > 0],na.rm = T)/
                                mean(risk[risk > 0],na.rm = T) * 100,2),
            `BGRI (premeal)` = round(mean(risk[risk < 0 & meal_factor == "premeal"],
                                          na.rm = T),1)+
              round(mean(risk[risk > 0 & meal_factor == "premeal"],na.rm = T),1),
            `LBGI (premeal)` = paste0(-round(mean(risk[risk < 0 & meal_factor == "premeal"],
                                                  na.rm = T),1),
                          " \u00B1 ",
                          round(sd(risk[risk < 0 & meal_factor == "premeal"],na.rm = T),1))
              ,
            `HBGI (premeal)` = paste0(round(mean(risk[risk > 0 & meal_factor == "premeal"],
                                                 na.rm = T),1),
                          " \u00B1 ",
                          round(sd(risk[risk > 0 & meal_factor == "premeal"],na.rm = T),1)),
            `BGRI (postmeal)` = round(mean(risk[risk < 0 & meal_factor == "postmeal"],
                                          na.rm = T),1)+
              round(mean(risk[risk > 0 & meal_factor == "postmeal"],na.rm = T),1),
            `LBGI (postmeal)` = paste0(-round(mean(risk[risk < 0 & meal_factor == "postmeal"],
                                                  na.rm = T),1),
                          " \u00B1 ",
                          round(sd(risk[risk < 0 & meal_factor == "postmeal"],na.rm = T),1))
              ,
            `HBGI (postmeal)` = paste0(round(mean(risk[risk > 0 & meal_factor == "postmeal"],
                                                 na.rm = T),1),
                          " \u00B1 ",
                          round(sd(risk[risk > 0 & meal_factor == "postmeal"],na.rm = T),1)),
            `BGRI (outmeal)` = round(mean(risk[risk < 0 & meal_factor == "outmeal"],
                                          na.rm = T),1)+
              round(mean(risk[risk > 0 & meal_factor == "outmeal"],na.rm = T),1),
            `LBGI (outmeal)` = paste0(-round(mean(risk[risk < 0 & meal_factor == "outmeal"],
                                                  na.rm = T),1),
                          " \u00B1 ",
                          round(sd(risk[risk < 0 & meal_factor == "outmeal"],na.rm = T),1))
              ,
            `HBGI (outmeal)` = paste0(round(mean(risk[risk > 0 & meal_factor == "outmeal"],
                                                 na.rm = T),1),
                          " \u00B1 ",
                          round(sd(risk[risk > 0 & meal_factor == "outmeal"],na.rm = T),1)),
            `SD Rate of Change (RoC)` = round(sd(slope, na.rm=T),2),
            `% offvalues [-2,2] RoC` = 100*round((length(slope[slope>quan95(slope) &
                                                                 !is.na(slope)]) +
                                          length(slope[slope<quan5(slope)&
                                                                 !is.na(slope)])) /
                                      length(slope[!is.na(slope)]),3),
            `Time in range` = round(100*length(Range[Range == "In range"&
                                                                 !is.na(Range)])/
                                length(Range[!is.na(Range)]),1),
            `Time in hyperglycemia` = round(100*length(Range[Range == "High"&
                                                                 !is.na(Range)])/
                                length(Range[!is.na(Range)]),1),
            `Time in extreme hyperglycemia` = round(100*length(Range[Range == "Very high"&
                                                                 !is.na(Range)])/
                                length(Range[!is.na(Range)]),1),
            `Time in hypoglycemia` = round(100*length(Range[Range == "Low"&
                                                                 !is.na(Range)])/
                                length(Range[!is.na(Range)]),1),
            `Time in extreme hypoglycemia` = round(100*length(Range[Range == "Very low"&
                                                                 !is.na(Range)])/
                                length(Range[!is.na(Range)]),1),
            ) %>% 
  t() %>% as.data.frame() %>% 
  rownames_to_column("Stat") %>% rename(Value="V1")

df1 <- rbind(df1, glu.mes.global)
```
### summarize 2
```{r}
timeday <- fi2 %>% group_by(timeday) %>% 
  summarize(TIR = length(Range[Range == "In range" & !is.na(Range)])/
                                length(Range[!is.na(Range)]),
            HBGI = round(mean(risk[risk > 0],na.rm = T),4),
            LBGI = -round(mean(risk[risk < 0],na.rm = T),4)
            )
weekday <- fi2 %>% group_by(weekday) %>% 
  summarize(TIR = length(Range[Range == "In range" & !is.na(Range)])/
                                length(Range[!is.na(Range)]),
            HBGI = round(mean(risk[risk > 0],na.rm = T),4),
            LBGI = -round(mean(risk[risk < 0],na.rm = T),4)
            )

sum2 <- data.frame(Stat = c("Week day with worst TIR",
                             "Week day with highest HBGI",
                            "Week day with highest LBGI",
                           "Time of day with worst TIR",
                           "Time of day with highest HBGI",
                           "Time of day with highest LBGI"),
           Value = c(paste(as.character(weekday$weekday[weekday$TIR == min(weekday$TIR)]),
                           collapse=", "),
                     paste(as.character(weekday$weekday[weekday$HBGI == max(weekday$HBGI)]),
                           collapse=", "),
                     paste(as.character(weekday$weekday[weekday$LBGI == max(weekday$LBGI)]),
                           collapse=", "),
                     paste(timeday$timeday[timeday$TIR == min(timeday$TIR)],
                           collapse=", "),
                     paste(timeday$timeday[timeday$HBGI == max(timeday$HBGI)],
                           collapse=", "),
                     paste(timeday$timeday[timeday$LBGI == max(timeday$LBGI)],
                           collapse=", ")
                     ))




df1 <- rbind(df1, sum2)
```

### events summarize
```{r}
hyper_hypo <- events %>%
  group_by(Event_subtype) %>% 
  summarize(Value = round(n()/as.numeric(to - from),2),
            ) %>%
  filter(Event_subtype != "Normoglycemia") %>% 
  mutate(Stat = c("N hyperglycemia/day",
                    "N hypoglycemia/day")) %>% 
  select(-Event_subtype)
df1 <- rbind(df1, hyper_hypo)  

overcor <- events %>%
  group_by(Event_subtype) %>% 
  summarize(Value = round(length(Overcorrection[Overcorrection=="Yes"])/
                             length(Overcorrection),2)
            ) %>%
  filter(Event_subtype != "Normoglycemia") %>% 
  mutate(Stat = c("% hypoglycemia overcorrection",
           "% hyperglycemia overcorrection")) %>% 
  select(-Event_subtype)

df1 <- rbind(df1, overcor)

```

```{r}
mes.ins <- data.frame(matrix(nrow=0, ncol=3))
stats.ins <- c("Total Insulin/day", "Total bolus insulin/day",
               "Total basal insulin/day", "N bolus/day",
               "Mean basal rate", "CV basal rate",
               "N bolus/meal", "Normal bolus size",
               "N temporal basal/day", "N 0 basal/day",
               "N bolus outmeal/day",
               "N detected meals/day",
               "Correlation BGRI - active insulin")


```

## summarize insulin

```{r}
ins.mes.global <-
  fi2 %>%
  summarize(`Total Insulin/day` = round((sum(Injec_bolus) + sum(Basal_rate*(5/60))) /
              as.numeric(to - from),1),
            `Total bolus insulin/day` = round(sum(Injec_bolus) /as.numeric(to - from),1),
            `Total basal insulin/day` = round(sum(Basal_rate*(5/60)) /as.numeric(to - from),1),
            `N bolus/day` = round(length(Bolus_type[!is.na(Bolus_type)])/as.numeric(to - from),1),
            `Mean basal rate` = round(mean(Basal_rate, na.rm=T),1),
            `CV basal rate` = round(sd(Basal_rate, na.rm=T)/
                                      mean(Basal_rate,na.rm = T) * 100,1),
            `Normal bolus size` = paste0(round(mean(Injec_bolus[Bolus_type == "Normal"],
                                                    na.rm=T),1),
                                    " \u00B1 ",
                                    round(sd(Injec_bolus[Bolus_type == "Normal"],
                                             na.rm=T),1)),
            `N temporal basal/day` = round(length(Action[Action == "Temporal_basal_start" &
                                                           !is.na(Action)])/
                                      as.numeric(to - from),1),
            `N 0 basal/day` = round(length(Action[Action=="Temporal_basal_start" &
                                                    Basal_rate == 0 & !is.na(Action)])/
                                      as.numeric(to - from),1)
            # `Correlation BGRI - active insulin` = round(cor(Total_ActI[!(is.na(Total_ActI) |
            #                                                                is.na(risk))],
            #                                           risk[!(is.na(Total_ActI) | is.na(risk))]),2)
              
              
            )%>% 
  t() %>% as.data.frame() %>% 
  rownames_to_column("Stat") %>% rename(Value="V1")

```

```{r}
ev.sum <- events %>% 
  summarize(`N bolus/meal` = paste0(round(mean(N_bolus[Event_type == "Meal"], na.rm=T),1),
                                    " \u00B1 ",
                                    round(sd(N_bolus[Event_type == "Meal"],na.rm=T),1)),
            `N bolus outmeal/day` = paste0(round(mean(N_bolus[Event_type == "No_Meal"], na.rm=T),1),
                                    " \u00B1 ",
                                    round(sd(N_bolus[Event_type == "No_Meal"],na.rm=T),1)),
            `N detected meals/day` = round(length(Event_type[Event_type == "Meal"])/
                                              as.numeric(to - from),1)
              )%>% 
  t() %>% as.data.frame() %>% 
  rownames_to_column("Stat") %>% rename(Value="V1")

df2 <- rbind(ins.mes.global, ev.sum)
```

```{r}
saveRDS(fi2, paste0("out/Integration_fi2_", Sys.Date() ,".rds"))
saveRDS(events, paste0("out/Events_", Sys.Date() ,".rds"))
writexl::write_xlsx(list(df1,df2), paste0("out/stats_measurement_", Sys.Date(), ".xlsx"))
```

# Stats
```{r}
events <- events %>% 
  mutate(start = as_datetime(start,tz = Sys.timezone()),
         end = as_datetime(end,tz = Sys.timezone()),
    weekday = factor(weekdays(start),
                          levels=c("lunes","martes","miércoles",
                                   "jueves", "viernes","sábado",
                                   "domingo" ),
                          labels=c("Monday", "Tuesday",
                                   "Wednesday", "Thursday",
                                   "Friday", "Saturday",
                                   "Sunday")),
         # time of day morning, midday, afternoon, evening, night
         timehour = as.numeric(format(start, "%H")),
         timeday = ifelse(timehour >= morning[1] & timehour < morning[2],
                          "morning",
                          ifelse(timehour >= midday[1] & timehour < midday[2],
                                 "midday",
                           ifelse(timehour >= afternoon[1] & timehour < afternoon[2],
                                  "afternoon",
                              ifelse(timehour >= evening[1] & timehour <= evening[2],
                                     "evening",
                                ifelse(timehour >= nigth[1] & timehour <= nigth[2],
                                       "night", NA)
                            )))),
         timeday = factor(timeday,
                          levels=c("morning","midday", "afternoon",
                                   "evening","night"))
                  ) 
e2 <- events %>% 
  select(grep("type|AUC|ActI|extreme|N_bolus|timeday|weekday|start|end", names(.),value = T)) %>% 
  filter(Event_subtype != "Normoglycemia")

```
### chisq 
```{r}
cq.hyper <- e2 %>% filter(Event_subtype == "Hyperglycemia") %>%  
              with(table(weekday))
cq.hyper
chisq.test(cq.hyper)
cq.hypo <- e2 %>% filter(Event_subtype == "Hypoglycemia") %>%  
              with(table(weekday))
cq.hypo
chisq.test(cq.hypo)

cq2.hyper <- e2 %>% filter(Event_subtype == "Hyperglycemia") %>%  
              with(table(timeday))
cq2.hyper
chisq.test(cq2.hyper)
cq2.hypo <- e2 %>% filter(Event_subtype == "Hypoglycemia") %>%  
              with(table(timeday))
cq2.hypo
chisq.test(cq2.hypo)

```
## regression
```{r}
e3 <- events %>% 
  filter(Event_subtype != "Normoglycemia") %>% 
  filter(complete.cases(.)) %>% 
  mutate(extrem.risk = 10*(1.509 * (log(extreme.value)^1.084 - 5.381)),
         slope.risk = 10*(1.509 * (log(Total_slope)^1.084 - 5.381)))
e3[is.infinite(e3$Diff_bolus),"Diff_bolus"] <- (time.bf+time.af)/60

# scaling and normalization
# select numerical variables for the model
num <- c("Total_slope", "Diff_bolus", "Bolus_ActI",
         "Basal_ActI", "Total_ActI", "N_bolus", "extrem.risk", "extreme.value")
X <- e3[,num] %>% scale(.)
# We calculate norma L2 using apply
L2 <- apply(X, 2, function(x) {sqrt(sum(x^2))})
# we divied each value for its respective norma L2
X <- X/L2
```

```{r}
cat <- c("Event_type", "Event_subtype", "weekday", "timeday")
lm.data <- cbind(e3[, cat], as.data.frame(X))
lm.data <- lm.data %>% 
  mutate(Event_subtype = factor(Event_subtype,
                             levels=c("Hypoglycemia", "Hyperglycemia"),
                             labels=c(0,1), ordered = T)
         )
lm1 <- lm(extrem.risk ~ Total_slope + Diff_bolus + Bolus_ActI + 
    Basal_ActI + N_bolus, lm.data)
summary(lm1)
step(lm(extrem.risk ~ Total_slope + Diff_bolus + Bolus_ActI +
            Basal_ActI + N_bolus + weekday +
            timeday, lm.data),
        direction="backward")

lm1 <- lm(extrem.risk ~ Total_slope + Diff_bolus + Bolus_ActI + 
    Basal_ActI + N_bolus, lm.data)
summary(lm1)

lm2 <- lm(extreme.value ~ Total_slope + Diff_bolus + Bolus_ActI + 
    Basal_ActI + N_bolus, lm.data)
summary(lm2)
```

## trees
```{r}
require(C50)
num <- c("Diff_bolus", "Bolus_ActI",
         "Basal_ActI", "Total_ActI", "N_bolus")
tree <- C5.0(lm.data[,num],
             lm.data$Event_subtype, trials = 10)
summary(tree)
plot(tree)
```
### logistic regression
```{r}
lgm <- glm(Event_subtype ~ Total_slope + Diff_bolus + Bolus_ActI + 
    Basal_ActI + N_bolus + weekday + timeday, data= lm.data, family = binomial)
summary(lgm)
exp(coef(lgm))
```

### PCA
```{r}
pca.set <- lm.data[, c(num[-c(7:8)])]
pc <- prcomp(pca.set)

pc$rotation
pc_sum <- summary(pc)
PC1_varexpl <- pc_sum$importance[2,"PC1"]
PC2_varexpl <- pc_sum$importance[2,"PC2"]

plot <- as.data.frame(pc$x[,1:2])
plot$event_subtype <- as.character(lm.data$Event_subtype)

ggplot(plot, aes(x = PC1, y= PC2, color=event_subtype)) +
  geom_point()

fpca <- FactoMineR::PCA(lm.data[, c(num[-c(7:8)])])
factoextra::fviz_pca_ind(fpca, label="none") +
  geom_point(aes(shape = factor(lm.data$Event_subtype),
                 colour = factor(lm.data$Event_type)))

factoextra::fviz_pca_biplot(fpca,
  habillage = lm.data$Event_subtype,
  col.var = "darkblue", alpha.var ="cos2",
  label = "var") +
  scale_color_brewer(palette="Dark2")+
  theme_bw()
```

## T-test
```{r}
# Assuming you have loaded your dataset into a dataframe called "e3"

# Create an empty data frame to store the test results
test_results <- data.frame(Variable = character(),
                           Test = character(),
                           foldchange= numeric(),
                           p_value = numeric(),
                           adjusted_p_value = numeric(),
                           stringsAsFactors = FALSE)

# Perform t-test or Mann-Whitney U test for each numerical variable
for (var in num) {
  # Split data based on event type
  hypoglycemia_data <- lm.data[lm.data$Event_subtype == "Hypoglycemia", var]
  hyperglycemia_data <- lm.data[lm.data$Event_subtype == "Hyperglycemia", var]
  fc = mean(hyperglycemia_data) / mean(hypoglycemia_data)
  
  # Perform normality test (Shapiro-Wilk test)
  normality_test_hypo <- shapiro.test(hypoglycemia_data)
  normality_test_hyper <- shapiro.test(hyperglycemia_data)
  
  # Perform t-test if data is normally distributed, otherwise perform Mann-Whitney U test
  if (normality_test_hypo$p.value > 0.05 && normality_test_hyper$p.value > 0.05) {
    t_test_result <- t.test(hypoglycemia_data, hyperglycemia_data)
    p_value <- t_test_result$p.value
    test_type <- "t-test"
  } else {
    mwu_test_result <- wilcox.test(hypoglycemia_data, hyperglycemia_data)
    p_value <- mwu_test_result$p.value
    test_type <- "Mann-Whitney U test"
  }
  
  # Bonferroni correction for multiple comparisons
  adjusted_p_value <- p.adjust(p_value, method = "bonferroni")
  
  # Store the test results
  test_results <- rbind(test_results, data.frame(Variable = var,
                                                 Test = test_type,
                                                 foldchange = fc,
                                                 p_value = p_value,
                                                 adjusted_p_value = adjusted_p_value))
}

# View the test results
print(test_results)


```

#plots
## gluplot on hours
```{r plot_1}
  # Definie colors for rangers of glucose
  colrange <- c("Very low" = "black",
            "Low" = "red",
            "In range" = "green",
            "High" = "yellow3",
            "Very high" = "orange")
  colrisk <- c("Hypoglycemia risk" = "red",
            "Hyperglycemia risk" = "yellow3")
  # Define colors and transparency for source of insulin
  colins <- c("Bolus" = "cornflowerblue",
              "Basal" = "deeppink",
              "Total" = "dimgray")
  alins <- c("Bolus" = 0.9,
              "Basal" = 0.2,
              "Total" = 0.3)
  colins2 <- c("Bolus" = "cornflowerblue",
              "Basal rate" = "deeppink")
  alins2 <- c("Bolus" = 1,
              "Basal rate" = 0.45)
  
the <- theme(legend.position = "bottom")
# declare an event as `e`
gluplot <- function(e){
  # extract info from minute-wise dataframe
  df <- fi2[fi2$time >= e$start & fi2$time <= e$end,] %>% 
    mutate(risk.range = ifelse(risk > 0,
                               "Hyperglycemia risk",
                               "Hypoglycemia risk"))
 
  

  pointplot <- df %>% filter(!is.na(glucose)) %>% 
    ggplot(aes(x=time ,y=glucose)) + 
    geom_point(size=1, aes(color = Range), show.legend= T, alpha=0.65) +
    scale_color_manual(values= colrange,  name = "Glucose Range") +
    guides(color = guide_legend(override.aes = list(size = 4)))+
    labs(title = paste0("Glucose reading on ",
                        min(format(df$time, "%Y-%m-%d" )),
                        "\n", e$Event_type, " - ", e$Event_subtype)) +
    geom_hline(yintercept = c(low,high), linetype = "dashed")+
    theme(plot.title = element_text(size=18,hjust = 0.5))+ 
    ylab("glucose (mg/dL)") + theme_bw() + xlab("Time")+
    scale_x_datetime(date_labels = "%H:%M",
                     date_breaks = "30 mins",
                     expand = c(0.01,0.01))+
    scale_y_continuous(breaks = c(55,70,100,140,180, 240,300)) +
    the
  
  riskplot <- df %>% filter(!is.na(risk)) %>% 
    ggplot(aes(x=time ,y=risk)) + 
    geom_col(size=1, aes(fill = risk.range), show.legend= T, alpha=0.65) +
    scale_fill_manual(values= colrisk,  name = "Glucose Risk") +
    guides(color = guide_legend(override.aes = list(size = 4)))+
    ylab("glycemic risk") + theme_bw() + xlab("Time")+
    scale_x_datetime(date_labels = "%H:%M",
                     date_breaks = "30 mins",
                     expand = c(0.01,0.01)) +
    the
  
  acti <- df %>% select(time, Bolus_ActI, Basal_ActI, Total_ActI) %>% 
    pivot_longer(-time, names_to = "Insulin_source",
                 values_to = "Active insulin") %>% 
    mutate(Insulin_source = factor(Insulin_source,
                                   levels=c("Bolus_ActI", "Basal_ActI", "Total_ActI"),
                                   labels=c("Bolus", "Basal", "Total"))) %>% 
    ggplot(aes(time, `Active insulin`,
               fill=Insulin_source))+
    geom_area(aes(alpha=Insulin_source), position="identity")+
    scale_fill_manual(values = colins, name = "Insulin source")+
    scale_alpha_manual(values= alins, guide="none")+
    ylab("Insulin in plasma (U)") + theme_bw() + xlab("Time")+
    scale_x_datetime(date_labels = "%H:%M",
                     date_breaks = "30 mins",
                     expand = c(0.01,0.01))+
    labs(title = "Insulin in plasma")+
    the
  
  evs <- df %>% select(time, Bolus_type, Injec_bolus, Action, Basal_rate) %>% 
    pivot_longer(-c(time, Bolus_type, Action), names_to = "Insulin_source",
                 values_to = "Insulin") %>% 
    mutate(Insulin_source = factor(Insulin_source,
                                   levels=c("Injec_bolus", "Basal_rate"),
                                   labels=c("Bolus", "Basal rate"))) %>%
    ggplot(aes(time, Insulin, fill=Insulin_source))+
    geom_col(aes(alpha= Insulin_source), stat="identity",position = "identity")+
    geom_text(aes(y = max(Insulin)/2, label=Action),
               angle=90, size=4, color="blue")+
    geom_text(aes(y = max(Insulin)/2, label=Bolus_type),
               angle=90, size=4)+
    scale_fill_manual(values = colins2, name = "Insulin source")+
    scale_alpha_manual(values= alins2, guide="none")+
    ylab("Insulin injected (U)") + theme_bw() + xlab("Time")+
    scale_x_datetime(date_labels = "%H:%M",
                     date_breaks = "30 mins",
                     expand = c(0.01,0.01))+
    labs(title = "Insulin injected")+
    the
  
  # merge all plots
  require(ggpubr)
  plotlist <- list(pointplot, riskplot, acti, evs)
  pl <- ggarrange(plotlist=plotlist, ncol=1,
                  heights = c(5,4,4,4))
  
  return(pl)
}

```

## histogram of BG rate of change (15 min)
```{r}
glucose %>% filter(!is.na(slope15) & abs(slope15)<10) %>% 
  ggplot(aes(slope15)) +
  geom_histogram()+
  stat_function(fun = dnorm,
                args = list(mean = mean(glucose$slope15, na.rm=T),
                            sd = sd(glucose$slope15, na.rm=T)))+
  scale_y_log10() +
  xlab("BG Rate of Change (mg/dL/min)")

```
## Poincaré plot
```{r}
pdf <- fi2 %>% select(glucose, weekday, timeday) %>% filter(complete.cases(.))
pdf <- data.frame(i = pdf$glucose[2:nrow(pdf)],
                  i.1 = pdf$glucose[1:(nrow(pdf)-1)],
                  timeday = pdf$timeday[-1],
                  weekday = pdf$weekday[-1])
pdf %>% 
  ggplot(aes(i.1,i))+
  geom_point()+
  stat_ellipse(level=0.99, color=2)

```


## Event-based clinical characteristics CVGA (24h periods)
```{r}
# dataframe for labels
coor <- data.frame(
  status = c("Upper C", "Upper D", "E-zone",
             "Upper B", "B-zone", "Lower D",
             "A-zone", "Lower B", "Lower C"),
  x = c(rep(c(100,80,60),3)),
  y = c(rep(350,3), rep(240,3), rep(145,3)),
  col = c("yellow3", "darkorange1", "red4",
          "darkgreen", "darkgreen", "darkorange1",
          "springgreen1", "darkgreen", "yellow3")
)

col <- coor %>% pull(col,name = status)

ebc.plot <- function(ebc, tit = NULL){
ebc.plot <- 
  ebc %>% 
    mutate(Max = ifelse(Max > 400, 400,
                         ifelse(Max < 110, 110, Max)),
           Min = ifelse(Min < 50, 50,
                         ifelse(Min > 110, 110, Min))
           ) %>% 
  ggplot(aes(Min, Max)) + 
    geom_point(size=2.5, alpha=0.6, color="royalblue4") +
    geom_label(data=coor, aes(label=status,
                              x= x, y= y, color=status)) +
    scale_color_manual(values=col) +
    geom_vline(xintercept = c(90,70))+
    geom_hline(yintercept = c(180,300))+
    theme_bw()+
    scale_y_continuous(limits = c(110, 400) ,
                       breaks = c(110,180,300,400),
                       expand = c(110,110)) +
    scale_x_continuous(limits = c(110,50),
                       breaks = c(50, 70, 90, 110),
                       expand = c(110,110),
                       trans = "reverse") +
    coord_cartesian(expand = F) +
    ggtitle(tit) +
    theme(plot.title = element_text(hjust = 0.5, size=18))
return(ebc.plot)

}
```

```{r}
fi2 %>% 
  mutate(day = format(time, "%D")) %>% 
  group_by(day) %>% 
  summarize(Max = max(glucose, na.rm = T),
            Min = min(glucose, na.rm=T)) %>% 
  ebc.plot(tit="24h")

for(i in unique(fi2$timeday)){
  fi2 %>% 
  mutate(day = format(time, "%D")) %>% 
  group_by(day, timeday) %>% 
  summarize(Max = max(glucose, na.rm = T),
            Min = min(glucose, na.rm=T)) %>% 
  filter(timeday == i) %>% 
  ebc.plot(tit=i) %>% print()
}

for(i in unique(fi2$weekday)){
  fi2 %>% 
  mutate(day = format(time, "%D")) %>% 
  group_by(day, weekday) %>% 
  summarize(Max = max(glucose, na.rm = T),
            Min = min(glucose, na.rm=T)) %>% 
  filter(weekday == i) %>% 
  ebc.plot(tit=i) %>% print()
}


for(i in unique(fi2$meal_factor[fi2$meal_factor != "meal"])){
  fi2 %>% 
  mutate(day = format(time, "%D")) %>% 
  group_by(day, meal_factor) %>% 
  summarize(Max = max(glucose, na.rm = T),
            Min = min(glucose, na.rm=T)) %>% 
  filter(meal_factor == i) %>% 
  ebc.plot(tit=i) %>% print()
}
```



try to find days/times of the day with risk of hypo/hyper


use risk rather than glucose for regression?? The advantages of risk plot include: (1) the variance carried by hypo- and hyperglycemic readings is equalized; (2) excursions into extreme hypo- and hyperglycemia get progressively increasing risk values; and (3) the variance within the safe euglycemic range is attenuated, which reduces noise during data analysis. In essence, Figure 3 links better glycemic control to a narrower pattern of risk fluctuations. Because the LBGI, HBGI, and the combined BGRI can theoretically range from 0 to 100, their values can be interpreted as percentages of maximum possible risk.

## Percentile plots
```{r}
the <- theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_text(size=18, face = "bold"),
        legend.text = element_text(size=17),
        plot.title = element_text(size=25, face="bold"),
        axis.title =element_text(size=18),
        axis.text = element_text(size=16))

perplot <- function(fi2, subtit=NULL, tx="20 mins"){
    allgluplot <- 
      fi2 %>% filter(!is.na(glucose)) %>% 
      mutate(hoursmin = as.POSIXct(format(time,"%H:%M"),format="%H:%M"),
             tenmin = as.POSIXct(format(round_date(time, tx),"%H:%M"),
                                 format="%H:%M")) %>% 
      ggplot(aes(x=hoursmin ,y=glucose)) +
      stat_summary(aes(tenmin, fill = "coral1"), fun.min = quan5,
                   fun.max = quan95, geom = "ribbon", alpha = 0.15)+
      stat_summary(aes(tenmin, fill = "chocolate4"), fun.min = quan25,
                   fun.max = quan75, geom = "ribbon", alpha = 0.5)+
      stat_summary(fun=median, aes(tenmin, linetype = "Median"),
                   geom="line", color = "coral4", size = 1.5)+
      scale_linetype_manual("", values=1)+
      scale_fill_manual(name = "", values= c("chocolate4","coral1"),
                        label = c("75% values", "95% values"))+
      guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Glucose sensor readings")) +
      geom_hline(yintercept = c(low,high), linetype = "dashed")+
      theme(plot.title = element_text(size=18,hjust = 0.5))+ 
      xlab("Time of the day")+
      ylab("glucose (mg/dL)") +
      scale_x_datetime(date_labels = "%H",date_breaks = "1 hour", expand = c(0.01,0.01))+
      scale_y_continuous(breaks = c(55,70,100,140,180, 240,300)) +
      the
    
    allriskplot <- 
      fi2 %>% 
      mutate(hoursmin = as.POSIXct(format(time,"%H:%M"),format="%H:%M"),
             tenmin = as.POSIXct(format(round_date(time, tx),"%H:%M"),
                                 format="%H:%M")) %>% 
      ggplot(aes(x=hoursmin ,y=risk)) +
      stat_summary(aes(tenmin, fill = "lightsalmon"), fun.min = quan5,
                   fun.max = quan95, geom = "ribbon", alpha = 0.3)+
      stat_summary(aes(tenmin, fill = "lightpink1"), fun.min = quan25,
                   fun.max = quan75, geom = "ribbon", alpha = 0.5)+
      stat_summary(fun=median, aes(tenmin, linetype = "Median"),
                   geom="line", colour = "lightpink4", size = 1.5)+
      scale_linetype_manual("", values=1)+
        scale_fill_manual(name = "", values= c("lightpink1","lightpink4"),
                        label = c("75% values", "95% values"))+
        guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Risk")) +
      geom_hline(yintercept = c(-2.5,5), linetype = "dashed")+
      xlab("Time of the day")+
      ylab("Risk") +
      scale_x_datetime(date_labels = "%H",date_breaks = "1 hour", expand = c(0.01,0.01))+
      the
    
    allinsplot <- 
      fi2 %>% 
      select(time, Bolus_ActI, Basal_ActI, Total_ActI) %>%
        pivot_longer(-time, names_to = "Insulin_source",
                     values_to = "Active insulin") %>% 
        mutate(`Insulin source` = factor(Insulin_source,
                                       levels=c("Bolus_ActI", "Basal_ActI", "Total_ActI"),
                                       labels=c("Bolus", "Basal", "Total")),
              hoursmin = as.POSIXct(format(time,"%H:%M"),format="%H:%M"),
             tenmin = as.POSIXct(format(round_date(time, tx),"%H:%M"),
                                 format="%H:%M")) %>%
      ggplot(aes(x=hoursmin, y=`Active insulin`)) +
      stat_summary(aes(tenmin, fill = `Insulin source`), fun.min = quan25,
                   fun.max = quan75, geom = "ribbon", alpha = 0.6)+
      stat_summary(fun=median, aes(tenmin, linetype = "Median",
                                   color=`Insulin source`),
                   geom="line", size = 1.5)+
      scale_linetype_manual("", values=1)+
      scale_fill_identity(name = "", label = "75% values", guide="legend") +
      scale_fill_manual(values= colins)+
      scale_color_manual(values=colins) +
      guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Insulin in plasma"))+ 
      xlab("Time of the day")+
      ylab("Insulin in plasma (U)") +
      scale_x_datetime(date_labels = "%H",date_breaks = "1 hour", expand = c(0.01,0.01))+
      the 
    
    alleveplot <- 
      fi2 %>% 
      select(time, Bolus_type, Action) %>%
        pivot_longer(-time, names_to = "Event",
                     values_to = "Type") %>% 
        filter(Type %in% c("Normal", "Temporal_basal_start")) %>% 
        mutate(hoursmin = as.POSIXct(format(time,"%H:%M"),format="%H:%M"),
             tenmin = as.POSIXct(format(round_date(time, tx),"%H:%M"),
                                 format="%H:%M"),
             Type = factor(Type,
                           labels=c("Bolus", "Temporal basal (start)"))) %>%
      ggplot(aes(x=hoursmin)) +
      geom_bar(aes(fill=Type)) +
        guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Events"))+ 
      xlab("Time of the day")+
      ylab("Number of events") +
      scale_x_datetime(date_labels = "%H",date_breaks = "1 hour", expand = c(0.01,0.01))+
      the
    
    # merge all plots
      require(ggpubr)
      plotlist <- list(allgluplot, allriskplot,
                       allinsplot, alleveplot)
      pl <- ggarrange(plotlist=plotlist, ncol=1,
                      heights = c(4.5,4,4,4)) 
      pl <- annotate_figure(pl,
                      top = text_grob(paste0("Data from ",
                                             min(format(fi2$time, "%Y-%m-%d" )),
                                             " to ",
                          max(format(fi2$time, "%Y-%m-%d")), ": ",
                          round(as.numeric(to - from)), " days.       ",
                          subtit), 
               color = "black", face = "bold", size = 32))
    
    return(pl)
}

```

```{r}
svg("figs/perplot.svg", height = 24, width=15)
perplot(fi2)
dev.off()

for(i in levels(fi2$weekday)){
  x <- fi2 %>% filter(weekday == i)
  svg(paste0("figs/perplot_",i,".svg"), height = 24, width=15)
    print(perplot(x, subtit=i))
  dev.off()
}

for(i in levels(fi2$timeday)){
  x <- fi2 %>% filter(timeday == i) %>% 
    mutate(hm = as.numeric(format(time, "%H%M"))) %>% 
    filter(hm < 2350)
  svg(paste0("figs/perplot_",i,".svg"), height = 24, width=15)
    print(perplot(x, subtit=i, tx="5 mins"))
  dev.off()
}


svg("figs/perplot_outmeal.svg", height = 24, width=15)
x <- fi2 %>% filter(meal_factor == "outmeal")
perplot(x, subtit="Outmeal")
dev.off()


## hyperglycemia
for(o in c("Hyperglycemia","Hypoglycemia")){
  x <- data.frame(matrix(nrow=0, ncol=length(fi2)))
  names(x) <- names(fi2)
  idx <- which(events$Event_subtype == o)
  for(i in idx){
    x0 <- fi2 %>% filter(time >= events[i,"start"] & time <= events[i,"end"])
    x <- rbind(x, x0)
  }
  svg(paste0("figs/perplot_", o,".svg"), height = 24, width=15)
    print(perplot(x, subtit=o))
  dev.off()
}
```

### meal percentile plots

```{r}
the <- theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_text(size=18, face = "bold"),
        legend.text = element_text(size=17),
        plot.title = element_text(size=25, face="bold"),
        axis.title =element_text(size=18),
        axis.text = element_text(size=16))

mealplot <- function(fi2, subtit=NULL, tx=10){
    allgluplot <- 
      fi2 %>% filter(!is.na(glucose)) %>% 
      filter(meal_factor != "outmeal") %>% 
      mutate(tenmin = plyr::round_any(mealtime,tx)) %>% 
      ggplot(aes(x=mealtime ,y=glucose)) +
      stat_summary(aes(tenmin, fill = "coral1"), fun.min = quan5,
                   fun.max = quan95, geom = "ribbon", alpha = 0.15)+
      stat_summary(aes(tenmin, fill = "chocolate4"), fun.min = quan25,
                   fun.max = quan75, geom = "ribbon", alpha = 0.5)+
      stat_summary(fun=median, aes(tenmin, linetype = "Median"),
                   geom="line", color = "coral4", size = 1.5)+
      scale_linetype_manual("", values=1)+
      scale_fill_manual(name = "", values= c("chocolate4","coral1"),
                        label = c("75% values", "95% values"))+
      guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Glucose sensor readings")) +
      geom_hline(yintercept = c(low,high), linetype = "dashed")+
      theme(plot.title = element_text(size=18,hjust = 0.5))+ 
      xlab("Time around meal (min)")+
      ylab("glucose (mg/dL)") +
      scale_y_continuous(breaks = c(55,70,100,140,180, 240,300)) +
      scale_x_continuous(expand = c(0.01,0.01))+
      geom_vline(xintercept = 0, linetype = "twodash", color="purple4")+
      the
    
    allriskplot <- 
      fi2 %>% 
      filter(meal_factor != "outmeal") %>% 
      mutate(tenmin = plyr::round_any(mealtime,tx)) %>% 
      ggplot(aes(x=mealtime ,y=risk)) +
      stat_summary(aes(tenmin, fill = "lightsalmon"), fun.min = quan5,
                   fun.max = quan95, geom = "ribbon", alpha = 0.3)+
      stat_summary(aes(tenmin, fill = "lightpink1"), fun.min = quan25,
                   fun.max = quan75, geom = "ribbon", alpha = 0.5)+
      stat_summary(fun=median, aes(tenmin, linetype = "Median"),
                   geom="line", colour = "lightpink4", size = 1.5)+
      scale_linetype_manual("", values=1)+
        scale_fill_manual(name = "", values= c("lightpink1","lightpink4"),
                        label = c("75% values", "95% values"))+
        guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Risk")) +
      geom_hline(yintercept = c(-2.5,5), linetype = "dashed")+
      scale_x_continuous(expand = c(0.01,0.01))+
      geom_vline(xintercept = 0, linetype = "twodash", color="purple4")+ 
      xlab("Time around meal (min)")+
      ylab("Risk") +
      the
    
    allinsplot <- 
      fi2 %>% 
        filter(meal_factor != "outmeal") %>%
        select(mealtime, Bolus_ActI, Basal_ActI, Total_ActI) %>%
          pivot_longer(-mealtime, names_to = "Insulin_source",
                       values_to = "Active insulin") %>% 
        mutate(tenmin = plyr::round_any(mealtime,tx),
               `Insulin source` = factor(Insulin_source,
                                 levels=c("Bolus_ActI", "Basal_ActI", "Total_ActI"),
                                 labels=c("Bolus", "Basal", "Total"))) %>%
      ggplot(aes(x=mealtime, y=`Active insulin`)) +
      stat_summary(aes(tenmin, fill = `Insulin source`), fun.min = quan25,
                   fun.max = quan75, geom = "ribbon", alpha = 0.6)+
      stat_summary(fun=median, aes(tenmin, linetype = "Median",
                                   color=`Insulin source`),
                   geom="line", size = 1.5)+
      scale_linetype_manual("", values=1)+
      scale_fill_identity(name = "", label = "75% values", guide="legend") +
      scale_fill_manual(values= colins)+
      scale_color_manual(values=colins) +
      guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Insulin in plasma"))+
      scale_x_continuous(expand = c(0.01,0.01))+
      geom_vline(xintercept = 0, linetype = "twodash", color="purple4")+
      xlab("Time around meal (min)")+
      ylab("Insulin in plasma (U)") +
      the 
    
    alleveplot <- 
      fi2 %>% 
        filter(meal_factor != "outmeal") %>%
      select(mealtime, Bolus_type, Action) %>%
        pivot_longer(-mealtime, names_to = "Event",
                     values_to = "Type") %>% 
        filter(Type %in% c("Normal", "Temporal_basal_start")) %>% 
        mutate(tenmin = plyr::round_any(mealtime,tx),
             Type = factor(Type,
                           labels=c("Bolus", "Temporal basal (start)"))) %>%
      ggplot(aes(x=mealtime)) +
      geom_bar(aes(fill=Type)) +
        guides(color = guide_legend(override.aes = list(size = 6)),
             fill = guide_legend(override.aes = list(size = 6)))+
      labs(title = paste0("Events"))+ 
      xlab("Time around meal (min)")+
      ylab("Number of events") +
      scale_x_continuous(expand = c(0.01,0.01))+
      geom_vline(xintercept = 0, linetype = "twodash", color="purple4")+
      the
    
    # merge all plots
      require(ggpubr)
      plotlist <- list(allgluplot, allriskplot,
                       allinsplot, alleveplot)
      pl <- ggarrange(plotlist=plotlist, ncol=1,
                      heights = c(4.5,4,4,4)) 
      pl <- annotate_figure(pl,
                      top = text_grob(paste0("Data from ",
                                             min(format(fi2$time, "%Y-%m-%d" )),
                                             " to ",
                          max(format(fi2$time, "%Y-%m-%d")), ": ",
                          round(as.numeric(to - from)), " days.       ",
                          subtit), 
               color = "black", face = "bold", size = 32))
    
    return(pl)
}

```


```{r}
svg("figs/perplot_meals.svg", height = 24, width=15)
mealplot(fi2)
dev.off()

```

## TIR plots
```{r}
svg("figs/all_tir.svg", height = 2, width = 7)
fi2 %>% 
  with(table(Range)) %>% prop.table() %>% 
  as.data.frame() %>%
  mutate(Freq = round(100*Freq),
         Freqann = paste0(Freq, "%")) %>% 
  ggplot(aes(y=Freq, x="",
             fill=Range, label=Freqann)) +
  geom_bar(stat="identity") +
  scale_fill_manual("", values=colrange)+
  ggrepel::geom_label_repel(aes(color=Range,fontface=2),
                            size = 4, face="bold", fill="grey65",
             position = position_stack(vjust = 0.5),
             show.legend = F)+
  scale_color_manual("", values=colrange)+
  theme_void() +
  coord_flip() +
  theme(legend.position = "bottom")
dev.off()

svg("figs/TIR_weekday.svg", height = 3, width = 10)
fi2 %>% 
  filter(!is.na(Range)) %>% 
  group_by(weekday, Range) %>% 
  summarize(Freq0 = n()) %>% as.data.frame() %>% 
  group_by(weekday) %>% 
  summarize(Freq = Freq0/sum(Freq0), Range= Range) %>% 
  mutate(Freq = round(100*Freq),
         Freqann = paste0(Freq, "%")) %>% 
  ggplot(aes(y=Freq, x="",
             fill=Range, label=Freqann)) +
  geom_bar(stat="identity") +
  scale_fill_manual("", values=colrange)+
  ggrepel::geom_label_repel(aes(color=Range, fontface=2),
                            size = 4, face="bold", fill="grey65",
             position = position_stack(vjust = 0.5),
             show.legend = F)+
  scale_color_manual("", values=colrange)+
  theme_void() +
  coord_flip() +
  theme(legend.position = "bottom")+
  facet_wrap(~weekday, ncol=4)
dev.off()

svg("figs/TIR_timeday.svg", height = 4, width = 9)
fi2 %>% 
  filter(!is.na(Range)) %>% 
  group_by(timeday, Range) %>% 
  summarize(Freq0 = n()) %>% as.data.frame() %>% 
  group_by(timeday) %>% 
  summarize(Freq = Freq0/sum(Freq0), Range= Range) %>% 
  mutate(Freq = round(100*Freq),
         Freqann = paste0(Freq, "%")) %>% 
  ggplot(aes(y=Freq, x="",
             fill=Range, label=Freqann)) +
  geom_bar(stat="identity") +
  scale_fill_manual("", values=colrange)+
  ggrepel::geom_label_repel(aes(color=Range, fontface=2),
                            size = 4, face="bold", fill="grey65",
             position = position_stack(vjust = 0.5),
             show.legend = F)+
  scale_color_manual("", values=colrange)+
  theme_void() +
  coord_flip() +
  theme(legend.position = "bottom")+
  facet_wrap(~timeday, ncol=3)
dev.off()

```

## boxplot
```{r}
gluweekbox <- 
  fi2 %>% 
  ggplot(aes(x = weekday, y = glucose)) +
  geom_jitter(aes(color=Range),alpha = 0.35, size = 0.5)+
  scale_color_manual(values= colrange)+
  guides(color = guide_legend(override.aes = list(size = 6)))+
  geom_boxplot(colour = "violetred4", fill = "snow3",
               size = 0.6, notch=F) +
  ylab("glucose (mg/dL)")+
  geom_hline(yintercept = c(low,high), linetype = "dashed")+
  theme_bw()

riskweekbox <- 
  fi2 %>% 
  ggplot(aes(x = weekday, y = risk)) +
  geom_jitter(aes(color=Range),alpha = 0.35, size = 0.5)+
  scale_color_manual(values= colrange)+
  guides(color = guide_legend(override.aes = list(size = 6)))+
  geom_boxplot(colour = "violetred4", fill = "snow3",
               size = 0.6, notch=F) +
  ylab("Risk")+
  geom_hline(yintercept = c(-2.5,5), linetype = "dashed")+
  theme_bw()

glutdbox <- 
  fi2 %>% 
  ggplot(aes(x = timeday, y = glucose)) +
  geom_jitter(aes(color=Range),alpha = 0.35, size = 0.5)+
  scale_color_manual(values= colrange)+
  guides(color = guide_legend(override.aes = list(size = 6)))+
  geom_boxplot(colour = "violetred4", fill = "snow3",
               size = 0.6, notch=F) +
  ylab("glucose (mg/dL)")+
  geom_hline(yintercept = c(low,high), linetype = "dashed")+
  theme_bw()

risktdbox <- 
  fi2 %>% 
  ggplot(aes(x = timeday, y = risk)) +
  geom_jitter(aes(color=Range),alpha = 0.35, size = 0.5)+
  scale_color_manual(values= colrange)+
  guides(color = guide_legend(override.aes = list(size = 6)))+
  geom_boxplot(colour = "violetred4", fill = "snow3",
               size = 0.6, notch=F) +
  ylab("Risk")+
  geom_hline(yintercept = c(-2.5,5), linetype = "dashed")+
  theme_bw()

```

## events plots
```{r}
# weekdays
ndays <- fi2 %>%
  mutate(day = format(time, "%D")) %>% 
  distinct(day, weekday) %>% 
  group_by(weekday) %>% 
  summarize(ndays = n())

eventweek <- rbind(
  events %>% group_by(weekday, Event_subtype) %>% 
  summarize(Count = n()) %>% rename(Event = "Event_subtype"),
  events %>% group_by(weekday, Event_type) %>% 
  summarize(Count = n()) %>% rename(Event = "Event_type")
  ) %>% filter(!Event %in% c("Normoglycemia", "No_Meal")) %>% 
  left_join(ndays, ., by= "weekday") %>% 
  mutate(Counts = Count/ndays) %>% 
  ggplot(aes(weekday, Counts, fill=Event)) +
  geom_col(position = "dodge2")+
  ylab("Counts/day of the week")+
  theme_bw()

# time of the day
ntime <- fi2 %>%
  mutate(day = format(time, "%D")) %>% 
  distinct(day, timeday) %>% 
  group_by(timeday) %>% 
  summarize(ntime = n())
eventday <- rbind(
  events %>% group_by(timeday, Event_subtype) %>% 
  summarize(Count = n()) %>% rename(Event = "Event_subtype"),
  events %>% group_by(timeday, Event_type) %>% 
  summarize(Count = n()) %>% rename(Event = "Event_type")
  ) %>% filter(!Event %in% c("Normoglycemia", "No_Meal")) %>% 
  left_join(ntime, ., by= "timeday") %>% 
  mutate(Counts = Count/ntime) %>% 
  ggplot(aes(timeday, Counts, fill=Event)) +
  geom_col(position = "dodge2")+
  ylab("Counts/time of day")+
  theme_bw()

```






